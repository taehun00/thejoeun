<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pawject.dao.user.UserMapper">
	<!-- 회원가입 -->
	<insert id="join" parameterType="UserDto">
		
	    INSERT INTO users (userid, email, nickname, password, ufile, mobile, createdat)
	    VALUES (users_seq.NEXTVAL, #{email}, #{nickname}, #{password}, #{ufile, jdbcType=VARCHAR}, #{mobile}, SYSDATE)
		<selectKey keyProperty="userId" resultType="int" order="AFTER">
	        SELECT users_seq.CURRVAL FROM dual
	    </selectKey>
	</insert>
	
	<select id="countByMobile" parameterType="string" resultType="int">
    	SELECT COUNT(*) FROM users WHERE mobile = #{mobile}
	</select>
	
	<!-- 권한 부여 -->
	<insert id="joinAuth" parameterType="AuthDto">
		insert into authorities (userid, auth) values (#{userId}, #{auth})
	</insert>
	
	<resultMap type="UserDto" id="userMap">
  	<result    property="userId"  column="USERID" />
  	<result    property="email"  	 column="EMAIL" />
  	<result    property="password"   column="PASSWORD" />
  	<result    property="createdAt"  column="CREATEDAT" />
  	<result    property="ufile"  	 column="UFILE" />
  	<result    property="mobile"  	 column="MOBILE" />
  	<result    property="nickname"   column="NICKNAME" />
  	</resultMap>
  	
  	<resultMap type="AuthDto" id="authMap">
  	<result    property="auth"  	 column="AUTH" />
  	<result    property="userId"  column="USERID" />
    </resultMap> 
    
    <resultMap type="UserAuthDto" id="userAuthMap">
  		<result    property="email"  	 	 column="EMAIL" />
  		<result    property="password"  	 column="PASSWORD" />
  		<result    property="userId"  column="USERID" />
  		<collection    property="authList"  	 resultMap="authMap" />
  	</resultMap> 
    
    <!-- 로그인 , 이메일을 기준으로 사용자 정보와 권한 보여줌 -->
    <select  resultMap="userAuthMap" id="readAuth" parameterType="UserDto">
    	select     u.userid, u.email, u.password, a.auth
    	from       users u    left join   authorities a   on  u.userid = a.userid 
    	where      u.email = #{email}
  	</select>
  	<select  resultMap="userAuthMap" id="readAuth1" parameterType="UserDto">
    	select     u.userid, u.email, u.password, a.auth
    	from       users u    left join   authorities a   on  u.userid = a.userid  
    	where      u.userid  = #{userId}
  	</select>
  	<!-- 마이페이지 -->
  	<select   resultMap="userMap" id="myPage" parameterType="UserDto">
  		select * from users  where  email=#{email} 
  	</select>
  	<!-- 아이디 찾기 -->
  	<select   resultType="string" id="findId" parameterType="UserDto">
  		SELECT email
		FROM users
		WHERE nickname = #{nickname}
  	</select>
  	<!-- 비밀번호 찾기 -->
  	<select   resultType="string" id="findPassword" parameterType="UserDto">
  		SELECT password FROM users
		WHERE nickname = #{nickname} AND email = #{email}
  	</select>
  	<!-- 정보수정 (사용자) -->
  	<update id="update" parameterType="UserDto">
  		UPDATE users
		SET email = #{email}, nickname = #{nickname},
		    password  = #{password}, ufile = #{ufile, jdbcType=VARCHAR} ,
		    mobile    = #{mobile}
		WHERE userid  = #{userId}
  	</update>
  	<!-- 정보수정 (관리자) 닉네임만 수정 -->
  	<update id="updateNickname" parameterType="UserDto">
	    UPDATE users
	    SET nickname = #{nickname}
	    WHERE userid = #{userId}
	</update>
  	

  	
  	<!-- 회원탈퇴 (사용자) -->
  	<delete  id="deleteMember" parameterType="UserDto">
  		DELETE FROM users
		WHERE userid = #{userId}
  	</delete>
  	<!-- 회원탈퇴 (관리자) -->
  	<delete id="deleteAuthoritiesByUserId" parameterType="int">
	    DELETE FROM authorities WHERE userid = #{userId}
	</delete>
  	<delete  id="deleteAdmin" parameterType="UserDto">
  		DELETE from users
		WHERE email = #{email}
  	</delete>
  	<!-- 여기까지 -->
	<!-- 전체유저 정보확인(관리자) + 페이징  -->
	<select id="listUsers" resultMap="userMap" parameterType="UserDto">
		SELECT *
        FROM (
            SELECT ROW_NUMBER() OVER (ORDER BY createdat DESC) AS rnum,
                   userid,
                   email,
                   nickname,
                   password,
                   ufile,
                   createdat,
                   mobile
            FROM users
        ) A
        WHERE A.rnum BETWEEN #{start} AND #{end}
	</select>
	<!-- 특정 유저 조회 (관리자용) -->
	<select id="selectUser" resultMap="userMap" parameterType="int">
	    SELECT userid,
	    	   email,
	           nickname,
	           password,
	           ufile,
	           createdat,
	           mobile
	    FROM users
	    WHERE userid = #{userId}
	</select>
	<!-- 이메일로 검색 -->
	<!-- 닉네임으로 검색 -->
	<select id="searchUsers" resultMap="userMap" parameterType="string">
	    SELECT u.userid,
	           u.email,
	           u.nickname,
	           u.createdat
	    FROM users u
	    WHERE u.email LIKE CONCAT(CONCAT('%', #{keyword}), '%')
	       OR u.nickname LIKE CONCAT(CONCAT('%', #{keyword}), '%')
	    ORDER BY u.createdat DESC
	</select>


	
	
</mapper>