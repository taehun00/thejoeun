# USERS 테이블 + sequence (user_seq)

| 컬럼명        | 데이터 타입         | 제약 조건                 | 설명 |
|--------------|-------------------|--------------------------|------|
| `userid`     | `NUMBER`          | `PRIMARY KEY`            | 사용자 고유 ID |
| `email`      | `VARCHAR2(200)`   | `NOT NULL`, `UNIQUE`     | 이메일 주소 |
| `nickname`   | `VARCHAR2(100)`   | `NOT NULL`               | 닉네임 |
| `password`   | `VARCHAR2(100)`   | `NOT NULL`               | 비밀번호 |
| `ufile`      | `VARCHAR2(255)`   | `DEFAULT 'default.png'`  | 이미지파일 |
| `createdat`  | `DATE`            | `NOT NULL`               | 가입일 |
| `mobile`     | `VARCHAR2(200)`   | `NULL`, `UNIQUE`         | 폰번호 |


### 회원가입(사용자)(관리자)
INSERT INTO users (userid, email, nickname, password, ufile, mobile, createdat)
           VALUES (users_seq.NEXTVAL, ?, ?, ?, ?, ?, SYSDATE);

### 로그인(사용자)(관리자)(두번째꺼가 security 버전)
SELECT COUNT(*) FROM users WHERE email=? AND password=?;

> ★security (username, password, 권한들)
  select     u.email, password, auth
  from       appuser u    left join   authorities a   on  u.email = a.email  
  where      u.email=#{email}
 

#### 권한부여(사용자, 관리자)
INSERT INTO authorities (email, auth)
VALUES (?, 'ROLE_MEMBER');

INSERT INTO authorities (email, auth)
VALUES (?, 'ROLE_ADMIN');



### 마이페이지(사용자)(관리자)
select * from users where email=?;

### 아이디 찾기(사용자)(관리자)(임시)
SELECT email
FROM users
WHERE nickname = ?;


### 비밀번호 찾기(사용자)(관리자)(임시)
SELECT password
FROM users
WHERE nickname = ? AND email = ?;

### 정보수정(사용자)
UPDATE users
SET email     = ?,
    nickname  = ?,
    password  = ?,
    ufile     = ?,
    mobile    = ?,
WHERE userid  = ?;


### 회원탈퇴(첫번째 사용자)(두번째 관리자)
DELETE FROM users
WHERE userid = ?;

DELETE from users
WHERE email = ?;

### 전체유저 정보확인(관리자)  ★페이징 끝

SELECT *
FROM (
    SELECT ROW_NUMBER() OVER (ORDER BY createdat DESC) AS rnum,
           userid,
           email,
           nickname,
           password,
           ufile,
           createdat,
           mobile
    FROM users
) A
WHERE A.rnum BETWEEN #{start} AND #{end};



### 해당 유저 검색(관리자)
<!-- 이메일로 검색 -->
<!-- 닉네임으로 검색 -->

SELECT u.userid,
       u.email,
       u.nickname,
       u.createdat
FROM users u
WHERE u.email   LIKE '%' || ? || '%'
   OR u.nickname LIKE '%' || ? || '%'
ORDER BY u.createdat DESC;


>  ★동적 mybatis 끝

# PETTYPE 테이블
| 컬럼명           | 데이터 타입       | 제약 조건         | 설명 |
|-----------------|-------------------|------------------|------|
| `pettypeid`     | `NUMBER`          | `PRIMARY KEY`    | 반려동물 종류 ID |
| `pettypename`   | `VARCHAR2(100)`   | `NOT NULL`       | 종류 이름 (강아지, 고양이 등) |

# PET 테이블 + sequence (pet_seq)

| 컬럼명        | 데이터 타입       | 제약 조건                                | 설명 |
|---------------|-------------------|------------------------------------------|------|
| `petid`       | `NUMBER`          | `PRIMARY KEY`                            | 반려동물 고유 ID |
| `userid`       | `NUMBER`          | `FOREIGN KEY REFERENCES user(userid)`    | 사용자 ID |
| `petname`     | `VARCHAR2(100)`   | `NOT NULL`                               | 반려동물 이름 |
| `petbreed`    | `VARCHAR2(100)`   | `NOT NULL`                                | 반려동물 종 |
| `birthdate`    | `VARCHAR2(100)`   | —                                        | 생년월일 |
| `pettypeid`  | `NUMBER`          | `FOREIGN KEY REFERENCES pettype(pet_type_id)` | 반려동물 종류 ID |
| `pfile`      | `VARCHAR2(255)`   | `DEFAULT 'default.png'`                    | 반려동물 이미지파일 |
| `createdat`  | `DATE`            | `NOT NULL`                                 | 반려동물등록일 |


### 펫 정보 작성(사용자)

INSERT INTO pet (petid, userid, petname, petbreed, birthdate, pettypeid, createdat, pfile)
VALUES (pet_seq.NEXTVAL, ?, ?, ?, ?, ?, SYSDATE, ?);

INSERT INTO pet (petid, userid, petname, petbreed, birthdate, pettypeid, createdat, pfile)
VALUES (pet_seq.NEXTVAL, 1, '겨울이', '페르시안', '2022-06-12', 1, SYSDATE, DEFAULT);

### 펫 페이지(로그인 시 해당유저의 전체펫 조회)(사용자)

SELECT p.petid,
       p.petname,
       p.petbreed,
       p.birthdate,
       p.pettypeid,
       p.createdat,
       p.pfile
FROM pet p
JOIN users u ON p.userid = u.userid
WHERE u.userid = ?
ORDER BY p.createdat DESC;

### 전체 펫 페이지(관리자) 
> ★페이징 끝


SELECT *
FROM (
    SELECT ROW_NUMBER() OVER (ORDER BY p.createdat DESC) AS rnum,
           p.petid,
           u.email,
           p.petname,
           p.petbreed,
           p.birthdate,
           p.pettypeid,
           p.createdat,
           p.pfile
    FROM pet p
    JOIN users u ON p.userid = u.userid
) A
WHERE A.rnum BETWEEN #{start} AND #{end};




### 상세페이지(로그인 시 해당유저의 상세펫 조회)(사용자)

SELECT p.petid,
       p.petname,
       p.petbreed,
       p.birthdate,
       p.pettypeid,
       p.createdat,
       p.ufile
FROM pet p
JOIN users u ON p.userid = u.userid
WHERE u.email = ?   -- 로그인한 유저 이메일
  AND p.petid = ?;  -- 선택한 펫 ID



> ★마이바티스 - 동적 끝

### 펫 정보 수정(사용자)(관리자)

<!-- 사용자는 이미 로그인을 한 상태이므로 userid를 가지고 있음 -->

<!-- 관리자 -->
UPDATE pet
SET petname   = ?,
    petbreed  = ?,
    birthdate = ?,
    pettypeid = ?,
    pfile     = ?
WHERE petid   = ?;

### 펫 정보 삭제(사용자)(관리자)
<!-- 관리자 -->
DELETE FROM pet
WHERE petid = ?;

### 검색 기능(관리자)
#### (이메일)
#### (펫이름)

SELECT 
    p.petid,
    u.email,
    p.petname,
    p.petbreed,
    p.birthdate,
    p.pettypeid,
    p.createdat,
    p.pfile
FROM pet p
JOIN users u ON p.userid = u.userid
WHERE u.email LIKE '%' || ? || '%'
   OR p.petname LIKE '%' || ? || '%'
ORDER BY u.createdat DESC;
