<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pawject.dao.support.CSQuestionDao"> 
  <resultMap id="CSQuestionMap" type="CSQuestionDto">
    <result property="questionid" column="QUESTIONID"/>
    <result property="userid" column="USERID"/>
    <result property="category"    column="CATEGORY"/>
    <result property="title"  column="TITLE"/>
    <result property="content"  column="CONTENT"/>
    <result property="status"  column="STATUS"/>
    <result property="createdat"      column="CREATEDAT"/>
    <result property="nickname"      column="NICKNAME"/>

  </resultMap> 
  
  <!-- 전체 조회 -->
  <select resultMap="CSQuestionMap" id="selectCSQAll">
  	SELECT 
    Q.QUESTIONID, Q.USERID, Q.CATEGORY, Q.TITLE, Q.CONTENT, Q.STATUS, Q.CREATEDAT, U.NICKNAME
	FROM CSQUESTION Q LEFT JOIN USERS U ON(Q.USERID=U.USERID)
  </select>
  
  
  
  <!-- 특정 질문 조회 -->	
  <select resultMap="CSQuestionMap" id="selectCSQ" parameterType="int">
    SELECT 
    Q.QUESTIONID, Q.USERID, Q.CATEGORY, Q.TITLE, Q.CONTENT, Q.STATUS, Q.CREATEDAT, U.NICKNAME
	FROM CSQUESTION Q LEFT JOIN USERS U ON(Q.USERID=U.USERID)
	WHERE Q.QUESTIONID=#{questionid}
  </select>
  
  <!-- 유저 작성글 조회 -->
  <select resultMap="CSQuestionMap" id="selectCSQUser" parameterType="CSQuestionDto">
  	SELECT * FROM CSQUESTION WHERE USERID=#{userid}
  </select>  
  
 
  <!-- 등록 -->
  <insert id="insertCSQ" parameterType="CSQuestionDto">
	INSERT INTO CSQUESTION(QUESTIONID, USERID, CATEGORY, TITLE, CONTENT)
        VALUES(CSQUESTION_SEQ.NEXTVAL, #{userid}, #{category}, #{title}, #{content})
  </insert>
  

  
  <!-- 답변 완료 전환-->
  <update id="answerCSQ" parameterType="CSQuestionDto">
    UPDATE CSQUESTION SET STATUS = CASE WHEN STATUS = 1 THEN 0	ELSE 1 END
    WHERE QUESTIONID = #{questionid}
  </update>
  
  <delete id="deleteCSQ" parameterType="int">
  DELETE FROM CSQUESTION WHERE QUESTIONID=#{questionid}
  </delete>





	<!-- 페이징 (1) -->
	<select  id="select10CSQ"  parameterType="java.util.HashMap"  resultMap="CSQuestionMap">
		select * from(
			select row_number() over(order by questionid desc)  as rnum, 
		    Q.QUESTIONID, Q.USERID, Q.CATEGORY, Q.TITLE, Q.CONTENT, Q.STATUS, Q.CREATEDAT, U.NICKNAME
			FROM CSQUESTION Q LEFT JOIN USERS U ON(Q.USERID=U.USERID)
		) A  
		where  A.rnum  between  #{start}  and #{end}
		order by questionid desc
	</select>

	<!-- 페이징 (2) -->
	<select  id="selectTotalCntCSQ"  resultType="int">
		select count(*)  from CSQUESTION order by questionid desc
	</select>
	
	<!-- 페이징+검색어(3) -->
	<select  id="selectSearchCSQ"  parameterType="java.util.HashMap"  resultMap="CSQuestionMap">
		select * from(
			select row_number() over(order by questionid desc)  as rnum, 
		    Q.QUESTIONID, Q.USERID, Q.CATEGORY, Q.TITLE, Q.CONTENT, Q.STATUS, Q.CREATEDAT, U.NICKNAME
			FROM CSQUESTION Q LEFT JOIN USERS U ON(Q.USERID=U.USERID)
	    <where>
	        <choose>
	            <when test="searchType == 'title'">
	              lower(q.title) like #{search}
	            </when>
	            
	            <when test="searchType == 'status'">
	                q.status = #{search} 
	            </when>
	            
				<when test="searchType == 'userid'">
				    u.nickname like #{search}
				</when>

	        </choose>
	    </where>
		) A  
		where  A.rnum  between  #{start}  and #{end}	
		order by questionid desc
	

	</select> 
	
	<!-- 페이징+검색어(4) 검색어 기준 전체 건수 -->
	<select id="selectSearchTotalCntCSQ" parameterType="string" resultType="int">
	    SELECT COUNT(*)
	    FROM CSQUESTION
	    <where>
	        <choose>
	            <when test="searchType == 'title'">
	              lower(title) like #{search}
	            </when>
	            
	            <when test="searchType == 'status'">
	                status = #{search} 
	            </when>
	            
				<when test="searchType == 'userid'">
				    userid like #{search}
				</when>

	        </choose>
	    </where>
	</select>







 <!-- 특정 유저(서치 추가 시)SELECT * FROM CSQUESTION WHERE USERID=1;-->
 <!-- 미답변 확인(서치 추가 시) SELECT * FROM CSQUESTION WHERE STATUS=0;-->
  



</mapper>