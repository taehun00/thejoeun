<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{fragments/layout}">
<head lang="ko">
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
	<div layout:fragment="content">

<!-- ê¶Œí•œ ë³µêµ¬  '[ë¬¸ìì—´]'   [ìˆ«ì] ì°¨ì´ ì¡°ì‹¬!-->
<script th:inline="javascript">
    const loginUserId = [[${userid}]];
    const loginRole   = '[[${author}]]';
</script>	
	
	
<div class="review-container">

    <h2 class="review-title">ğŸ¶ì‚¬ë£Œ í›„ê¸°ğŸ±</h2>
    
        <input type="hidden" id="currentPage" th:value="${reviewpaging.pstartno}">
		<input type="hidden" name="userid" th:value="${userid}">
		<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
    
       <div class="row my-3">
		    <!-- ê°€ìš´ë° ì •ë ¬ ì˜ì—­ -->
		    <div class="col d-flex justify-content-center gap-2">
		        <select id="searchType" class="form-select" style="width:150px;">
		            <option value="all">ì „ì²´</option>
		            <option value="pettypeid">ê°•ì•„ì§€/ê³ ì–‘ì´</option>
		            <option value="brandname">ë¸Œëœë“œëª…</option>
		            <option value="foodname">ì‚¬ë£Œëª…</option>
		        </select>
		
		        <input type="text" id="searchKeyword" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" class="form-control" style="width:300px;">
		        <button class="btn btn-mint" onclick="searchReview()">ê²€ìƒ‰</button>
				<a id="searchlistBtn"
				   class="btn btn-slateBlue"
				   th:href="@{/reviewboard/reviewlist}"
				   style="display:none;">
				   ëª©ë¡ë³´ê¸°
				</a>

		        
		    </div>
		

		</div>		
   <table class="review-table table table-bordered table-hover align-middle text-center">
        <caption class="visually-hidden">ì‚¬ë£Œ í›„ê¸°</caption>
        
		
        <thead class="table-light">
            <tr>
                <th style="display:none;"></th>
                <th scope="col">NO.</th>
                <th scope="col">ë¸Œëœë“œ</th>
                <th scope="col">ì œí’ˆëª…</th>
                <th scope="col">í‰ì </th>
                <th scope="col">ì œëª©</th>
                <th scope="col">ì‘ì„±ì</th>
                <th scope="col">ë“±ë¡ì¼</th>
                <th scope="col">ìˆ˜ì •ì¼</th>
            </tr>
        </thead>

        <tbody>
        </tbody>
		<tfoot>
		<tr>
		<td colspan="9">
		    <ul class="pagination justify-content-center">
		

                    <!-- ì´ì „ -->
                    <li class="page-item"
                        th:if="${reviewpaging.start > 10}">   
                                             
                        <a href="#" class="page-link"
                        th:onclick="|reviewPaging(${reviewpaging.start - 1})|">ì´ì „</a>
                    </li>
		
					<!-- í˜ì´ì§€ ìˆ«ì -->
                    <li class="page-item"
                        th:each="i : ${#numbers.sequence(reviewpaging.start, reviewpaging.end)}"
                        th:classappend="${i == reviewpaging.current} ? 'active'">
                        <a href="#" class="page-link"
                        th:onclick="|reviewPaging(${i})|"
                        th:text="${i}">1</a>
                    </li>
                    		
		
		        <!-- ë‹¤ìŒ -->
                    <li class="page-item"
                        th:if="${reviewpaging.pagetotal > reviewpaging.end}">   
                                           
                        <a href="#" class="page-link"
                        th:onclick="|reviewPaging(${reviewpaging.end + 1})|">ë‹¤ìŒ</a>
                    </li>		        

		    </ul>
		</td>
		</tr>
		</tfoot>
       </table>
      
		
		
	<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
	
		    <div class="write-btn-area"
			    sec:authorize="hasAnyRole('ROLE_ADMIN','ROLE_MEMBER')" >
				<a class="btn btn-slateBlue"
				   id="writeBtn"
				   th:href="@{/reviewboard/reviewwrite}">
				   ë¦¬ë·° ì‘ì„±
				</a>
		        		 
		    </div>

	

</div>

<script>

//ì „ì—­ ìƒíƒœ
let currentMode = "list";       
let currentSearchType = "";
let currentKeyword = "";

//ì²« ë¡œë”©
/* $(function() {
 const currentPage = $("#currentPage").val() || 1;
 reviewPaging(currentPage);
});
 */
 // ì‚¬ë£Œì°¾ê¸° í˜ì´ì§€ ì—°ê²° ì¶”ê°€ ë²„ì „
$(function () {
    const params = new URLSearchParams(window.location.search);
    const foodid = params.get("foodid");

    console.log("URL foodid =", foodid);

    if (foodid) {
        loadReviewsByFoodid(foodid);
    } else {
        const currentPage = $("#currentPage").val() || 1;
        reviewPaging(currentPage);
    }
});

//ê²€ìƒ‰ ê¸°ëŠ¥
function doReviewSearch(searchType, keyword) {
    currentMode = "search";
    currentSearchType = searchType;
    currentKeyword = keyword;

    $("#currentPage").val(1); //ê²€ìƒ‰ ì§„ì… ì‹œ í˜ì´ì§€ ì´ˆê¸°í™”**
    
    $.ajax({
        url: "/reviewboard/reviewsearch",
        type: "GET",
        data: { keyword: keyword, searchType: searchType },
        success: function(json) {
            reviewPagingResult(json, 1);
            $("#searchlistBtn").show();
            $("tfoot").hide();
            $("#writeBtn").hide();
        }
    }); 
}

function searchReview(){
    const keyword = $("#searchKeyword").val().trim();
    const searchType = $("#searchType").val();

    if(keyword.length === 0){
        alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
    }

    doReviewSearch(searchType, keyword);
}

//idë¡œ ì‚¬ë£Œ ì¡°íšŒ
function loadReviewsByFoodid(foodid){
    currentMode = "food";
    $("#currentPage").val(1);

    $.ajax({
        url: "/reviewboard/reviewsearchByFoodid",
        type: "GET",
        data: { foodid: foodid },
        success: function (json) {
            reviewPagingResult(json, 1);
            $("#searchlistBtn").show();
            $("tfoot").hide();
            $("#writeBtn").hide();
        },
        error: function(xhr) {
            console.error("foodid ì¡°íšŒ ì‹¤íŒ¨", xhr.responseText);
        }
    });
}



//í˜ì´ì§•
function reviewPaging(pstartno){
    currentMode = "list";
	$.ajax({
		url:"/reviewboard/reviewPaging",
        type: "GET",
        data: { pstartno: pstartno },
        success: function(json) {
        	reviewPagingResult(json, pstartno);  // í˜ì´ì§• ê¸°ëŠ¥ë•Œë§¤ í•„ìš”
        	 $("tfoot").show();  //í˜ì´ì§• ë‹¤ì‹œ ë³´ì´ê¸°
        },
		error:function (xhr) {
		    console.error("ERROR:", xhr.responseText);
		    alert("ì—ëŸ¬ ë°œìƒ: " + xhr.status);}
	})
}

function ratingToStar(rating){
	if(rating==5) return "â˜…â˜…â˜…â˜…â˜…";
	if(rating==4) return "â˜…â˜…â˜…â˜…â˜†";
	if(rating==3) return "â˜…â˜…â˜…â˜†â˜†";
	if(rating==2) return "â˜…â˜…â˜†â˜†â˜†";
	if(rating==1) return "â˜…â˜†â˜†â˜†â˜†";
	
}

function reviewPagingResult(json, pstartno) {
    console.log(json);
 
 
    let list = json.list;
    let total = json.total;
    
    let tbody = $(".review-table tbody");
    tbody.empty();
  
    if (!list || list.length === 0) {
        tbody.append(
            $("<tr>").append(
                $("<td>")
                    .attr("colspan", 9)
                    .text("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.")
            )
        );
        return;
    }

    $.each(list, function(idx, review)  {
    	let number = total - ((pstartno - 1) * 10 + idx);

    	
    	
    	//ìš”ì•½-ë°”ë¡œ ë³´ì´ëŠ” í–‰
		let summary = $("<tr>")
			.addClass("review-row")
			.attr("onclick", "toggleContent(" + review.reviewid + ")")
			.append($("<td>").css("display","none").text(review.reviewid))
			.append($("<td>").text(number))
			.append($("<td>").text(review.brandname))
			.append($("<td>").text(review.foodname))
			.append($("<td>").html(ratingToStar(review.rating)))
			.append($("<td>").text(review.title))
			.append($("<td>").text(review.nickname))
			.append($("<td>").text(review.createdat))
			.append($("<td>").text(review.updatedat));

		tbody.append(summary);

    	
    	//ì—¬ê¸°ì„œë¶€í„° ìŠ¤ë¶ˆì¬ ì‹œì‘
		let detail = $("<tr>")
		    .attr("id", "content-" + review.reviewid)
		    .addClass("review-detail")
		    .css("display", "none");
		
		let td = $("<td>").attr("colspan", 9);
		
		// detail-inner-table
		let innerTable = $("<table>").addClass("detail-inner-table");
		
		// inner table row
		let innerTr = $("<tr>");
		
		//ì´ë¯¸ì§€
		let foodImgTd = $("<td>")
		    .addClass("detail-img");
		
		let foodImg = $("<img>")
		    .addClass("review-thumb")
			.attr("src", "/foodimg/" + review.foodimg)
			.on("click", () => openImg("/foodimg/" + review.foodimg));
		
		foodImgTd.append(foodImg);
		
		let contentTd = $("<td>")
		    .addClass("detail-content");
		
		let imgWrap = $("<div>").addClass("review-img-wrap");
		
		review.reviewimglist.forEach(function(img) {
		    let imgBox = $("<div>").addClass("review-img-box");
		
		    let reviewImg = $("<img>")
		        .addClass("review-img")
				.attr("src", "/upload/" + img.reviewimgname)
				.on("click", () => openImg("/upload/" + img.reviewimgname));
		
		    imgBox.append(reviewImg);
		    imgWrap.append(imgBox);
		});
		
		let comment = $("<p>")
		    .addClass("detail-text")
		    .text(review.reviewcomment);
		let btns = $("<div>").addClass("detail-btns");


		// ê´€ë¦¬ìëŠ” ì „ì²´ ë²„íŠ¼ í‘œì‹œ
		if (loginRole === "ROLE_ADMIN") {
		
		    btns.append(
		        $("<button>")
		            .addClass("btn btn-green")
		            .text("ìˆ˜ì •")
		            .on("click", () => {
		                location.href = "/reviewboard/reviewedit?reviewid=" + review.reviewid;
		            })
		    );
		
		    btns.append(
		        $("<button>")
		            .addClass("btn btn-olive")
		            .text("ì‚­ì œ")
		            .on("click", () => {
		                location.href = "/reviewboard/reviewdelete?reviewid=" + review.reviewid;
		            })
		    );
		}
		
		// ì¼ë°˜ íšŒì›ì´ë©´ ë³¸ì¸ ê¸€ë§Œ ë²„íŠ¼ í‘œì‹œ
		else if (loginRole === "ROLE_MEMBER" && review.userid == loginUserId) {
		
		    btns.append(
		        $("<button>")
		            .addClass("btn btn-green")
		            .text("ìˆ˜ì •")
		            .on("click", () => {
		                location.href = "/reviewboard/reviewedit?reviewid=" + review.reviewid;
		            })
		    );
		
		    btns.append(
		        $("<button>")
		            .addClass("btn btn-olive")
		            .text("ì‚­ì œ")
		            .on("click", () => {
		                location.href = "/reviewboard/reviewdelete?reviewid=" + review.reviewid;
		            })
		    );
		}
		// contentTd êµ¬ì„±
		contentTd.append(imgWrap);
		contentTd.append(comment);
		contentTd.append(btns);
		
		// inner row ì¡°ë¦½
		innerTr.append(foodImgTd);
		innerTr.append(contentTd);
		
		// innerTable ì¡°ë¦½
		innerTable.append(innerTr);
		
		// tdì— innerTable ì‚½ì…
		td.append(innerTable);
		
		// detail row ì™„ì„±
		detail.append(td);
		
		// tbodyì— detail ì¶”ê°€
		tbody.append(detail);

    });   //$.each ë‹«ìŒ

}   // function reviewPagingResult ë‹«ìŒ


function toggleContent(id) {
    let row = document.getElementById("content-" + id);
    if (!row) return;  // ì•ˆì „ì¥ì¹˜
    row.style.display = (row.style.display === "none") ? "table-row" : "none";
}

function openImageModal(src){
    document.getElementById("modalImg").src = src;
    document.getElementById("imgModal").style.display = "flex";
}


function openImg(url) {
    window.open(
        url, 
        "_blank",
        "width=800,height=600,toolbar=no,menubar=no,resizable=yes"
    );
}
</script>
 
	</div><!-- content-->
</body>
</html>