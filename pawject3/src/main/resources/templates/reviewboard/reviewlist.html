<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{fragments/layout}">
<head lang="ko">
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
	<div layout:fragment="content">

<!-- ê¶Œí•œ ë³µêµ¬  '[ë¬¸ìì—´]'   [ìˆ«ì] ì°¨ì´ ì¡°ì‹¬!-->
<!-- <script th:inline="javascript">
    const loginUserId = [[${userid}]];
    const loginRole   = '[[${author}]]';
</script>	
 -->
<script th:inline="javascript">
    const loginRole = /*[[${author}]]*/ null;
    const loginUserId = /*[[${userid}]]*/ null;
</script>	


<script>
console.log("loginRole =", loginRole);
console.log("loginUserId =", loginUserId);
</script>	
<div class="review-container">

    <h2 class="review-title">ğŸ¶ì‚¬ë£Œ í›„ê¸°ğŸ±</h2>
    
        <input type="hidden" id="currentPage" th:value="${reviewpaging.pstartno}">
		<input type="hidden" name="userid" th:value="${userid}">
		<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
    
       <div class="row my-3">
		    <!-- ê°€ìš´ë° ì •ë ¬ ì˜ì—­ -->
		    <div class="col d-flex justify-content-center gap-2">
		        <select id="searchType" class="form-select" style="width:150px;">
		            <option value="all">ì „ì²´</option>
		            <option value="pettypeid">ê°•ì•„ì§€/ê³ ì–‘ì´</option>
		            <option value="brandname">ë¸Œëœë“œëª…</option>
		            <option value="foodname">ì‚¬ë£Œëª…</option>
		        </select>
		
		        <input type="text" id="searchKeyword" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" class="form-control" style="width:300px;">
		        <button class="btn btn-mint" onclick="searchReview()">ê²€ìƒ‰</button>
				<a id="searchlistBtn"
				   class="btn btn-slateBlue"
				   th:href="@{/reviewboard/reviewlist}"
				   style="display:none;">
				   ëª©ë¡ë³´ê¸°
				</a>

		        
		    </div>
		

		</div>		
   <table class="review-table table table-bordered table-hover align-middle text-center">
        <caption class="visually-hidden">ì‚¬ë£Œ í›„ê¸°</caption>
        
		
        <thead class="table-light">
            <tr>
                <th style="display:none;"></th>
				<th class="col-no">NO.</th>
				<th class="col-brand">ë¸Œëœë“œ</th>
				<th class="col-food">ì œí’ˆëª…</th>
				<th class="col-rating">í‰ì </th>
				<th class="col-title">ì œëª©</th>
				<th class="col-writer">ì‘ì„±ì</th>
				<th class="col-created">ë“±ë¡ì¼</th>
				<th class="col-updated">ìˆ˜ì •ì¼</th>
            </tr>
        </thead>

        <tbody>
        </tbody>
		<tfoot>
		<tr>
		<td colspan="9">
		    <ul class="pagination justify-content-center">
		

                    <!-- ì´ì „ -->
                    <li class="page-item"
                        th:if="${reviewpaging.start > 10}">   
                                             
                        <a href="#" class="page-link"
                        th:onclick="|reviewPaging(${reviewpaging.start - 1})|">ì´ì „</a>
                    </li>
		
					<!-- í˜ì´ì§€ ìˆ«ì -->
                    <li class="page-item"
                        th:each="i : ${#numbers.sequence(reviewpaging.start, reviewpaging.end)}"
                        th:classappend="${i == reviewpaging.current} ? 'active'">
                        <a href="#" class="page-link"
                        th:onclick="|reviewPaging(${i})|"
                        th:text="${i}">1</a>
                    </li>
                    		
		
		        <!-- ë‹¤ìŒ -->
                    <li class="page-item"
                        th:if="${reviewpaging.pagetotal > reviewpaging.end}">   
                                           
                        <a href="#" class="page-link"
                        th:onclick="|reviewPaging(${reviewpaging.end + 1})|">ë‹¤ìŒ</a>
                    </li>		        

		    </ul>
		</td>
		</tr>
		</tfoot>
       </table>
      
		
		
	<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
	
		    <div class="write-btn-area"
			    sec:authorize="hasAnyRole('ROLE_ADMIN','ROLE_MEMBER')" >
				<a class="btn btn-slateBlue"
				   id="writeBtn"
				   th:href="@{/reviewboard/reviewwrite}">
				   ë¦¬ë·° ì‘ì„±
				</a>
		        		 
		    </div>

	

</div>

<script>

//ì „ì—­
let currentMode = "list";
let currentSearchType = "";
let currentKeyword = "";

//ì´ˆê¸° ë¡œë”©
$(function () {
 const params = new URLSearchParams(window.location.search);
 const foodid = params.get("foodid");

 if (foodid) {
     loadReviewsByFoodid(foodid);
 } else {
     const currentPage = $("#currentPage").val() || 1;
     reviewPaging(currentPage);
 }
});

//ê²€ìƒ‰
function doReviewSearch(searchType, keyword) {
 currentMode = "search";
 currentSearchType = searchType;
 currentKeyword = keyword;

 $("#currentPage").val(1);

 $.ajax({
     url: "/reviewboard/reviewsearch",
     type: "GET",
     data: { keyword, searchType },
     success: function (json) {
         reviewPagingResult(json, 1);
         $("#searchlistBtn").show();
         $("tfoot").hide();
         $("#writeBtn").hide();
     }
 });
}

function searchReview() {
 const keyword = $("#searchKeyword").val().trim();
 const searchType = $("#searchType").val();

 if (!keyword) {
     alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
     return;
 }
 doReviewSearch(searchType, keyword);
}

//foodid ì¡°íšŒ - ì‚¬ë£Œê²€ìƒ‰ í˜ì´ì§€ ì—°ê²°ìš©
function loadReviewsByFoodid(foodid) {
 currentMode = "food";
 $("#currentPage").val(1);

 $.ajax({
     url: "/reviewboard/reviewsearchByFoodid",
     type: "GET",
     data: { foodid },
     success: function (json) {
         reviewPagingResult(json, 1);
         $("#searchlistBtn").show();
         $("tfoot").hide();
         $("#writeBtn").hide();
     }
 });
}

//í˜ì´ì§•
function reviewPaging(pstartno) {
 currentMode = "list";
 $.ajax({
     url: "/reviewboard/reviewPaging",
     type: "GET",
     data: { pstartno },
     success: function (json) {
         reviewPagingResult(json, pstartno);
         $("tfoot").show();
     }
 });
}

//í‰ì  ì‹œê°í™”
function ratingToStar(rating) {
 if (rating == 5) return "â˜…â˜…â˜…â˜…â˜…";
 if (rating == 4) return "â˜…â˜…â˜…â˜…â˜†";
 if (rating == 3) return "â˜…â˜…â˜…â˜†â˜†";
 if (rating == 2) return "â˜…â˜…â˜†â˜†â˜†";
 if (rating == 1) return "â˜…â˜†â˜†â˜†â˜†";
}

//ëœë”ë§
function reviewPagingResult(json, pstartno) {
 console.log("json =", json);
 console.log("json.list =", json.list);

 const list = json.list;
 const total = json.total;
 const tbody = $(".review-table tbody");

 tbody.empty();

 tbody.off("click", ".review-row");
 tbody.on("click", ".review-row", function () {
     toggleContent($(this).data("id"));
 });

 if (!list || list.length === 0) {
     tbody.append(
         $("<tr>").append(
             $("<td>").attr("colspan", 9).text("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.")
         )
     );
     return;
 }

 $.each(list, function (idx, review) {
     const number = total - ((pstartno - 1) * 10 + idx);

     // ìš”ì•½í–‰
     const summary = $("<tr>")
         .addClass("review-row")
         .data("id", review.reviewid)
         .append($("<td>").addClass("col-no").text(number))
         .append($("<td>").addClass("col-brand").text(review.brandname))
         .append($("<td>").addClass("col-food").text(review.foodname))
         .append($("<td>").addClass("col-rating").html(ratingToStar(review.rating)))
         .append($("<td>").addClass("col-title").text(review.title))
         .append($("<td>").addClass("col-writer").text(review.nickname))
         .append($("<td>").addClass("col-created").text(review.createdat))
         .append($("<td>").addClass("col-updated").text(review.updatedat));

     tbody.append(summary);

     // ìƒì„¸ í–‰
     const detail = $("<tr>")
         .attr("id", "content-" + review.reviewid)
         .addClass("review-detail")
         .hide();

     const td = $("<td>").attr("colspan", 9);

     const innerTable = $("<table>").addClass("detail-inner-table");
     const innerTr = $("<tr>");

     // ì‚¬ë£Œ ì´ë¯¸ì§€
     const foodImgTd = $("<td>").addClass("detail-img").append(
         $("<img>")
             .addClass("review-thumb")
             .attr("src", "/foodimg/" + review.foodimg)
             .on("click", function () {
                 openImg("/foodimg/" + review.foodimg);
             })
     );

     const contentTd = $("<td>").addClass("detail-content");

     const imgWrap = $("<div>").addClass("review-img-wrap");
     if (Array.isArray(review.reviewimglist)) {
         review.reviewimglist.forEach(function (img) {
             imgWrap.append(
                 $("<div>").addClass("review-img-box").append(
                     $("<img>")
                         .addClass("review-img")
                         .attr("src", "/upload/" + img.reviewimgname)
                         .on("click", function () {
                             openImg("/upload/" + img.reviewimgname);
                         })
                 )
             );
         });
     }

     const comment = $("<p>")
         .addClass("detail-text")
         .text(review.reviewcomment);

     // ë²„íŠ¼
 
		let btns = $("<div>").addClass("detail-btns");
		
		// ê´€ë¦¬ì-ì „ë¶€
		if (loginRole === "ROLE_ADMIN") {
		
		    btns.append(makeEditBtn(review.reviewid));
		    btns.append(makeDeleteBtn(review.reviewid));
		
		}
		// ì¼ë°˜ íšŒì›-ë‚´ ê¸€ë§Œ
		else if (
		    loginRole === "ROLE_MEMBER" &&
		    Number(review.userid) === Number(loginUserId)
		) {
		
		    btns.append(makeEditBtn(review.reviewid));
		    btns.append(makeDeleteBtn(review.reviewid));
		}

     // ì¡°ë¦½ ìˆœì„œ ì£¼ì˜
     contentTd.append(imgWrap);
     contentTd.append(comment);
     contentTd.append(btns);   //****!

     innerTr.append(foodImgTd);
     innerTr.append(contentTd);
     innerTable.append(innerTr);

     td.append(innerTable);
     detail.append(td);
     tbody.append(detail);
 });
}

//ë²„íŠ¼ìƒì„±
function makeEditBtn(reviewid) {
    return $("<button>")
        .addClass("btn btn-olive")
        .text("ìˆ˜ì •")
        .on("click", function (e) {
            e.stopPropagation();
            location.href = "/reviewboard/reviewedit?reviewid=" + reviewid;
        });
}

function makeDeleteBtn(reviewid) {
    return $("<button>")
        .addClass("btn btn-olive")
        .text("ì‚­ì œ")
        .on("click", function (e) {
            e.stopPropagation();
            if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            location.href = "/reviewboard/reviewdelete?reviewid=" + reviewid;
        });
}

//í† ê¸€
function toggleContent(id) {
 const row = document.getElementById("content-" + id);
 if (!row) return;
 row.style.display = (row.style.display === "none") ? "table-row" : "none";
}

//ì´ë¯¸ì§€ ìƒˆì°½
function openImg(url) {
 window.open(url, "_blank",
     "width=800,height=600,toolbar=no,menubar=no,resizable=yes");
}
</script>
 
	</div><!-- content-->
</body>
</html>