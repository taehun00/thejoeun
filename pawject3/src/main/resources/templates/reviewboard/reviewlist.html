<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{fragments/layout}">
<head lang="ko">
<meta charset="UTF-8">
<title>ì‚¬ë£Œ í›„ê¸°</title>
</head>
<body>
	<div layout:fragment="content">

<script th:inline="javascript">
    const loginRole = /*[[${author}]]*/ null;
    const loginUserId = /*[[${userid}]]*/ null;
</script>	


<script>
console.log("loginRole =", loginRole);
console.log("loginUserId =", loginUserId);
</script>	

<div class="review-container">

    <h2 class="review-title">ğŸ¶ì‚¬ë£Œ í›„ê¸°ğŸ±</h2>
   
		<input type="hidden" name="userid" th:value="${userid}">
		<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
    
       <div class="row my-3">
		    <!-- ê°€ìš´ë° ì •ë ¬ ì˜ì—­ -->
		    <div class="col d-flex justify-content-center gap-2">
		        <select id="searchType" class="form-select" style="width:150px;">
		            <option value="all">ì „ì²´</option>
		            <option value="pettypeid">ê°•ì•„ì§€/ê³ ì–‘ì´</option>
		            <option value="brandname">ë¸Œëœë“œëª…</option>
		            <option value="foodname">ì‚¬ë£Œëª…</option>
		        </select>
		
		        <input type="text" id="searchKeyword" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" class="form-control" style="width:300px;">
		        <button class="btn btn-mint" onclick="searchReview()">ê²€ìƒ‰</button>
				<a id="searchlistBtn"
				   class="btn btn-slateBlue"
				   th:href="@{/reviewboard/reviewlist}"
				   style="display:none;">
				   ëª©ë¡ë³´ê¸°
				</a>
		        
		    </div>
		    	<select id="condition" class="condition form-select justify-content-end" style="width:120px;">
			      <option value="">ìµœì‹ </option>
			      <option value="old">ì˜¤ë˜ëœìˆœ</option>
			    </select>

		</div>		
   <table class="review-table table table-bordered table-hover align-middle text-center">
        <caption class="visually-hidden">ì‚¬ë£Œ í›„ê¸°</caption>
        
		
        <thead class="table-light">
            <tr>
                <th style="display:none;"></th>
				<th class="col-no">NO.</th>
				<th class="col-brand">ë¸Œëœë“œ</th>
				<th class="col-food">ì œí’ˆëª…</th>
				<th class="col-rating">í‰ì </th>
				<th class="col-title">ì œëª©</th>
				<th class="col-writer">ì‘ì„±ì</th>
				<th class="col-created">ë“±ë¡ì¼</th>
				<th class="col-updated">ìˆ˜ì •ì¼</th>
            </tr>
        </thead>

        <tbody>
        </tbody>
       </table>
      
		
		
	<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
	
		    <div class="write-btn-area"
			    sec:authorize="hasAnyRole('ROLE_ADMIN','ROLE_MEMBER')" >
				<a class="btn btn-slateBlue"
				   id="writeBtn"
				   th:href="@{/reviewboard/reviewwrite}">
				   ë¦¬ë·° ì‘ì„±
				</a>
		        		 
		    </div>

		<!-- í˜ì´ì§• -->
	<div id="pagingArea" class="mt-2 text-center"  ></div>

</div>

<script>

//ì „ì—­ë³€ìˆ˜-í˜ì´ì§• í™”ë©´ ë¶„ê¸°
let currentMode = "list";
let currentSearchType = "";
let currentKeyword = "";
let currentPageNo = 1;

//ì „ì—­ë³€ìˆ˜-ì •ë ¬
let currentCondition = null;  

//ì´ˆê¸° ë¡œë“œ
$(function(){
  reviewPaging(1);
});

//ì •ë ¬
$(document).on("change", ".condition", function () {
    currentCondition = $(this).val() || null;
    currentPageNo = 1;

    if (currentMode === "search") {
        doReviewSearch(currentSearchType, currentKeyword, 1);
    } else {
        reviewPaging(1);
    }
});

//í˜ì´ì§• ë²„íŠ¼
$(document).on("click", ".pageBtn", function(){
	  let page = $(this).data("page");
	  currentPageNo = page;

	  if(currentMode === "search"){
	    doCSSearch(currentSearchType, currentKeyword, page);
	  } else {
	    csPaging(page);
	  }
	});


//ì „ì²´ ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€
function reviewPaging(pageNo){
  currentMode = "list";
  currentPageNo = pageNo;
  
  let data = { pageNo : pageNo };
  if (currentCondition) data.condition = currentCondition;	
  
  $.ajax({
    url: "/reviewboard/reviewPaging",
    type: "GET",
    data: data,
    success: function(json){	
      csPagingResult(json, pageNo);
      renderPaging(json.paging);
      $("#searchlistBtn").hide();   
    }
  });
}



//ê²€ìƒ‰
function doReviewSearch(searchType, keyword, pageNo) {
	  currentMode = "search";
	  currentSearchType = searchType;
	  currentKeyword = keyword;
	  currentPageNo = pageNo;
	  
	  let data = {
			  searchType: searchType,
			  keyword: keyword,
			  pageNo: pageNo
			};
	  if (currentCondition) data.condition = currentCondition;


 $.ajax({
     url: "/reviewboard/reviewsearch",
     type: "GET",
     data: data,
     success: function(json){
         if(!json.list || json.list.length === 0){
           alert("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
           return;
         }

         reviewPagingResult(json, pageNo);
         renderPaging(json.paging);
         $("#searchlistBtn").show();   
       }
     });
   }

function searchReview(){
	  let keyword = $("#searchKeyword").val().trim();
	  let searchType = $("#searchType").val();
	  

	  if(keyword === ""){
	    alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
	    return;
	  }

	  doReviewSearch(searchType, keyword, 1);
	}


//foodid ì¡°íšŒ - ì‚¬ë£Œê²€ìƒ‰ í˜ì´ì§€ ì—°ê²°ìš©
function loadReviewsByFoodid(foodid) {
 currentMode = "food";
 $("#currentPage").val(1);

 $.ajax({
     url: "/reviewboard/reviewsearchByFoodid",
     type: "GET",
     data: { foodid },
     success: function (json) {
         reviewPagingResult(json, 1);
         $("#searchlistBtn").show();
         $("tfoot").hide();
         $("#writeBtn").hide();
     }
 });
}


//í‰ì  ì‹œê°í™”
function ratingToStar(rating) {
 if (rating == 5) return "â˜…â˜…â˜…â˜…â˜…";
 if (rating == 4) return "â˜…â˜…â˜…â˜…â˜†";
 if (rating == 3) return "â˜…â˜…â˜…â˜†â˜†";
 if (rating == 2) return "â˜…â˜…â˜†â˜†â˜†";
 if (rating == 1) return "â˜…â˜†â˜†â˜†â˜†";
}

//ëœë”ë§
function reviewPagingResult(json, pstartno) {
	  let list = json.list;
	  let total = json.total;
	  let tbody = $(".review-table tbody");
	  tbody.empty();

 tbody.off("click", ".review-row");
 tbody.on("click", ".review-row", function () {
     toggleContent($(this).data("id"));
 });

 if (!list || list.length === 0) {
     tbody.append(
         $("<tr>").append(
             $("<td>").attr("colspan", 9).text("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.")
         )
     );
     return;
 }

 $.each(list, function (idx, review) {
     const number = total - ((pstartno - 1) * 10 + idx);

     // ìš”ì•½í–‰
     const summary = $("<tr>")
         .addClass("review-row")
         .data("id", review.reviewid)
         .append($("<td>").addClass("col-no").text(number))
         .append($("<td>").addClass("col-brand").text(review.brandname))
         .append($("<td>").addClass("col-food").text(review.foodname))
         .append($("<td>").addClass("col-rating").html(ratingToStar(review.rating)))
         .append($("<td>").addClass("col-title").text(review.title))
         .append($("<td>").addClass("col-writer").text(review.nickname))
         .append($("<td>").addClass("col-created").text(review.createdat))
         .append($("<td>").addClass("col-updated").text(review.updatedat));

     tbody.append(summary);

     // ìƒì„¸ í–‰
     const detail = $("<tr>")
         .attr("id", "content-" + review.reviewid)
         .addClass("review-detail")
         .hide();

     const td = $("<td>").attr("colspan", 9);

     const innerTable = $("<table>").addClass("detail-inner-table");
     const innerTr = $("<tr>");

     // ì‚¬ë£Œ ì´ë¯¸ì§€
     const foodImgTd = $("<td>").addClass("detail-img").append(
         $("<img>")
             .addClass("review-thumb")
             .attr("src", "/foodimg/" + review.foodimg)
             .on("click", function () {
                 openImg("/foodimg/" + review.foodimg);
             })
     );

     const contentTd = $("<td>").addClass("detail-content");

     const imgWrap = $("<div>").addClass("review-img-wrap");
     if (Array.isArray(review.reviewimglist)) {
         review.reviewimglist.forEach(function (img) {
             imgWrap.append(
                 $("<div>").addClass("review-img-box").append(
                     $("<img>")
                         .addClass("review-img")
                         .attr("src", "/upload/" + img.reviewimgname)
                         .on("click", function () {
                             openImg("/upload/" + img.reviewimgname);
                         })
                 )
             );
         });
     }

     const comment = $("<p>")
         .addClass("detail-text")
         .text(review.reviewcomment);

     // ë²„íŠ¼
 
		let btns = $("<div>").addClass("detail-btns");
		
		// ê´€ë¦¬ì-ì „ë¶€
		if (loginRole === "ROLE_ADMIN") {
		
		    btns.append(makeEditBtn(review.reviewid));
		    btns.append(makeDeleteBtn(review.reviewid));
		
		}
		// ì¼ë°˜ íšŒì›-ë‚´ ê¸€ë§Œ
		else if (
		    loginRole === "ROLE_MEMBER" &&
		    Number(review.userid) === Number(loginUserId)
		) {
		
		    btns.append(makeEditBtn(review.reviewid));
		    btns.append(makeDeleteBtn(review.reviewid));
		}

     // ì¡°ë¦½ ìˆœì„œ ì£¼ì˜
     contentTd.append(imgWrap);
     contentTd.append(comment);
     contentTd.append(btns);   //****!

     innerTr.append(foodImgTd);
     innerTr.append(contentTd);
     innerTable.append(innerTr);

     td.append(innerTable);
     detail.append(td);
     tbody.append(detail);
 });
}

//ë²„íŠ¼ìƒì„±
function makeEditBtn(reviewid) {
    return $("<button>")
        .addClass("btn btn-olive")
        .text("ìˆ˜ì •")
        .on("click", function (e) {
            e.stopPropagation();
            location.href = "/reviewboard/reviewedit?reviewid=" + reviewid;
        });
}

function makeDeleteBtn(reviewid) {
    return $("<button>")
        .addClass("btn btn-olive")
        .text("ì‚­ì œ")
        .on("click", function (e) {
            e.stopPropagation();
            if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            location.href = "/reviewboard/reviewdelete?reviewid=" + reviewid;
        });
}

//í† ê¸€
function toggleContent(id) {
 const row = document.getElementById("content-" + id);
 if (!row) return;
 row.style.display = (row.style.display === "none") ? "table-row" : "none";
}

//ì´ë¯¸ì§€ ìƒˆì°½
function openImg(url) {
 window.open(url, "_blank",
     "width=800,height=600,toolbar=no,menubar=no,resizable=yes");
}
//í˜ì´ì§• ëœë”
function renderPaging(p){
  let area = $("#pagingArea");
  area.empty();

  if(!p || p.pagetotal <= 1) return;

  let html = "";
  let end = Math.min(p.end, p.pagetotal);

  if(p.start > 1){
    html += `<button class="btn btn-sm btn-outline-primary pageBtn" data-page="${p.start-1}">ì´ì „</button>`;
  }

  for(let i=p.start; i<=end; i++){
    let active = (i === p.current) ? "btn-primary" : "btn-outline-primary";
    html += `<button class="btn btn-sm ${active} pageBtn ms-2" data-page="${i}">${i}</button>`;
  }

  if(end < p.pagetotal){
    html += `<button class="btn btn-sm btn-outline-primary pageBtn ms-2" data-page="${end+1}">ë‹¤ìŒ</button>`;
  }

  area.html(html);
}


</script>
 
	</div><!-- content-->
</body>
</html>