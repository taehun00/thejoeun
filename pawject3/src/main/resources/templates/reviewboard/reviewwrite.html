<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{fragments/layout}">
<head lang="ko">
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
	<div layout:fragment="content">
<script th:inline="javascript">
const csrfParam = [[${_csrf.parameterName}]];
const csrfToken = [[${_csrf.token}]];
</script>	
	
 <div class="container mt-5">
  <h3>리뷰 작성</h3>

  <form method="post" 
  		enctype="multipart/form-data" 
  		id="reviewUploadForm">
    <input type="hidden" name="nickname" th:value="${nickname}">

    <div class="row">
      <!-- 종 선택 -->
      <div class="col-2">
        <label class="form-check-label" for="pettypeid">종</label>
        <select name="pettypeid" id="pettypeid" class="form-select">
          <option value="">종 선택</option>
          <option value="1">고양이</option>
          <option value="2">강아지</option>
        </select>
      </div>

      <!-- 브랜드 선택 -->
		<div class="col-2">
			  <label class="form-check-label">브랜드 :</label>
			  <select name="brandid" id="brandid" class="form-control">
			    <option value="">-- 브랜드 선택 --</option>
			    <option th:each="b : ${brandlist}"
			            th:value="${b.brandid}"
			            th:text="${b.brandname}">
			    </option>
			  </select>
		</div>


      <!-- 제품 선택 -->
      <div class="col-3">
        <label class="form-check-label" for="foodid">제품명</label>
			  <select name="foodid" id="foodid" class="form-control">
			    <option value="">-- 제품 선택 --</option>	
			    <option th:each="f : ${foodlist}"
			    		th:data-pet="${f.pettypeid}"
			    		th:data-brand="${f.brandid}"
			            th:value="${f.foodid}"
			            th:text="${f.foodname}">
			    </option>
			  </select>
	</div>		  

      <!-- 평점 -->
      <div class="col-2">
        <label class="form-check-label" for="rating">평점</label>
        <select name="rating" id="rating" class="form-select">
          <option value="5">★★★★★</option>
          <option value="4">★★★★☆</option>
          <option value="3">★★★☆☆</option>
          <option value="2">★★☆☆☆</option>
          <option value="1">★☆☆☆☆</option>
        </select>
      </div>

      <!-- 버튼 -->
      <div class="col-3 d-flex justify-content-end align-items-end mt-4">
        <button type="button" class="btn btn-slateBlue me-2" onclick="submitReview()">등록</button>
        
		<a  class="btn btn-mint"
			th:text="목록보기"
			th:href="@{/reviewboard/reviewlist}"></a>

      </div>
    </div>

    <!-- 제목 -->
    <div class="row">
      <div class="mb-3 mt-4 col-6">
        <label for="title" class="form-label">TITLE:</label>
        <input type="text" class="form-control" id="title" name="title" placeholder="제목을 입력해 주세요">
      </div>
    </div>

    <!-- 내용 -->
    <div class="mb-3">
      <label for="reviewcomment" class="form-label">Comments:</label>
      <textarea class="form-control" rows="5" id="reviewcomment" name="reviewcomment"
                placeholder="리뷰를 작성해 주세요 (250자 이내)"></textarea>
    </div>

	<!-- 파일 업로드 + 프리뷰 -->
		<div class="row">
		   <div class="mb-3 mt-4 col-3 justify-content-end">
		      <label for="files" class="form-label">후기사진:</label>
		      <input type="file" class="form-control" id="files" name="files" multiple accept="image/*">
		   </div>
		</div>
		<div id="previewBox" class="preview-img-wrap"></div>
	<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

	<!-- 순화영역 -->
	
	<div class="my-4 ai-refine-box">
	  <p>작성한 리뷰를 조금 더 부드럽게 정리해 볼까요?</p>
	  <button type="button" id="sendBtn" class="btn btn-primary">✨다듬기</button>
	</div>
	
	<div class="mt-4 ai-result-box d-none" id="responseWrap">
	  <div class="ai-result-title">추천 멘트</div>
	  <pre id="response" class="ai-result-content"></pre>
	  <div class="mt-3 text-end">
	    <button type="button" id="applyBtn" class="btn btn-success">사용하기</button>
	  </div>
	</div>

  </form>
</div>


<script>

//결과 감췄다 보여줘서 이렇게 바꿔야됨 복잡...
let refinedTitle = "";
let refinedContent = "";

$(document).on("click", "#sendBtn", function () {

    let reviewcomment = $("#reviewcomment").val().trim();
    let title = $("#title").val().trim();

    if (reviewcomment.length <= 0 || title.length <= 0) {
        alert("제목과 내용을 작성해 주세요");
        return;
    }

    let data = {};
    data["title"] = title;
    data["reviewcomment"] = reviewcomment;
    data[csrfParam] = csrfToken;

    $.ajax({
        url: "/reviewboard/reviewpai",
        type: "POST",
        data: data,
        success: function(result){
            $("#response").text(result);
            $("#responseWrap").removeClass("d-none");

            // 결과 파싱
            refinedTitle = "";
            refinedContent = "";

            result.split("\n").forEach(line => {
                if (line.startsWith("제목:")) {
                    refinedTitle = line.replace("제목:", "").trim();
                }
                if (line.startsWith("내용:")) {
                    refinedContent = line.replace("내용:", "").trim();
                }
            });
        }
    });
});

$(document).on("click", "#applyBtn", function () {
    if (refinedTitle) {
        $("#title").val(refinedTitle);
    }
    if (refinedContent) {
        $("#reviewcomment").val(refinedContent);
    }
});
</script>



<!-- <script>
//ai 다듬기
$(function(){

    $("#sendBtn").on("click", function() {
        let reviewcomment = $("#reviewcomment").val().trim();
        let title = $("#title").val().trim();

        if (reviewcomment.length <= 0 || title.length <= 0) {
            alert("제목과 내용을 작성해 주세요");
            return;
        }
	//param 방식으로 변경
        let data = {};
        data["title"] = title;
        data["reviewcomment"] = reviewcomment;
        data[csrfParam] = csrfToken; // CSRF 추가

        $.ajax({
            url: "/reviewboard/reviewpai",
            type: "POST",
            data: data,
            success: function(result){
                $("#response").text(result);
            },
            error: function(xhr){
                $("#response").text("에러 발생 : " + xhr.responseText);
            }
        });
    });

});
</script> -->



<!-- 사료 선택 필터 -->
<script>
window.onload = function () {
  const pet = document.getElementById("pettypeid");
  const brand = document.getElementById("brandid");
  const food = document.getElementById("foodid");

  function filter() {
    const p = pet.value;
    const b = brand.value;

    for (let i = 0; i < food.options.length; i++) {
      const opt = food.options[i];

      if (!opt.getAttribute("data-pet")) {
        opt.style.display = "block";
        continue;
      }

      const matchPet = opt.getAttribute("data-pet") === p;
      const matchBrand = opt.getAttribute("data-brand") === b;

      opt.style.display = (matchPet && matchBrand) ? "block" : "none";
    }

    food.value = "";
  }

  pet.onchange = filter;
  brand.onchange = filter;
};
</script>


<!-- 이미지 미리보기 -->
<script>
let uploadFiles = [];   // 전체 이미지 목록 - 배열 꼭 넣어줘야됨
let previewIndex = 0;


document.getElementById("files").addEventListener("change", function (e) {

  const files = [...e.target.files];
  const previewBox = document.getElementById("previewBox");

  for (let i = 0; i < files.length; i++) {

    let file = files[i];
    uploadFiles.push(file);

    let reader = new FileReader();
    reader.onload = function (ev) {

      const div = document.createElement("div");
      div.className = "preview-img-box";

      div.innerHTML = 
    	  '<img src="' + ev.target.result + '" class="preview-img"/>' +
    	  '<button type="button" class="preview-del" data-index="' + previewIndex + '">X</button>';

      previewBox.appendChild(div);
      previewIndex++;
    };

    reader.readAsDataURL(file);
  }

  //e.target.value = ""; // 초기화 <-이거때매 이미지가 통으로 자꾸 날아감! 제거.
});
</script>

<!-- 프리뷰 삭제 기능 -->
<script>
document.getElementById("previewBox").addEventListener("click", function(e){
    if (!e.target.classList.contains("preview-del")) return;

    const index = Number(e.target.dataset.index);
    
    // DOM 삭제
    const box = e.target.closest(".preview-img-box");
    box.remove();

    // 배열에서도 제거 -> 업로드 제외)
    uploadFiles[index] = null;
});
</script>




<!-- 업로드 -->
<script>

function submitReview() {
    console.log("submitReview called");
}
function submitReview() {

	$.ajax({
		  url: "/reviewboard/reviewwrite",
		  type: "POST",
		  data: $("#reviewUploadForm").serialize(),
		  success: function (reviewid) {
		    console.log("SUCCESS:", reviewid);
		    uploadImages(reviewid);
		  },
		  error: function (xhr) {
		    console.error("ERROR:", xhr.responseText);
		    alert("에러 발생: " + xhr.status);
		  }
		});
}

function uploadImages(reviewid) {

  const realFiles = uploadFiles.filter(f => f != null);

  // 이미지 없는 경우
  if (realFiles.length === 0) {
    alert("리뷰 등록 성공");
    location.href="/reviewboard/reviewlist";
    return;
  }

  let uploaded = 0;

  for (let i = 0; i < realFiles.length; i++) {

    let fd = new FormData();
    fd.append("file", realFiles[i]);
    fd.append("reviewid", reviewid);
    fd.append(csrfParam, csrfToken);

    $.ajax({
    	url: "/reviewboard/reviewimg/upload",
      type: "POST",
      data: fd,
      contentType: false,
      processData: false,
      success: function (res) {

        uploaded++;

        if (uploaded === realFiles.length) {
          alert("리뷰 등록 성공");
          location.href="/reviewboard/reviewlist";
        }
      }
    });
  }
}
</script>
 
	</div><!-- content-->
</body>
</html>