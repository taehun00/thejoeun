<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	  layout:decorate="~{fragments/layout}">
<!-- 	#1. layout 렌더링	 -->
<head lang="ko">
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>

<div sec:authorize="isAuthenticated()">
	<div layout:fragment="content">
		<!--  알림메시지  -->
        <div th:if="${success}" class="alert alert-info alert-dismissible fade show" role="alert">
            <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
	
	
		<h3 class="card-header">날씨정보</h3>
		<table class="table table-striped table-bordered table-hover">
			<caption>날씨정보</caption>
			<thead>
				<tr>
			    	<th scope="col">번호</th> 
					<th scope="col">날씨</th> <!-- 글상세보기 링크 -->
					<th scope="col">최고기온</th>
			   		<th scope="col">최저기온</th>
					<th scope="col">습도</th>
			   		<th scope="col">강수량</th>
			   		<th scope="col">날짜</th>
				</tr>
			</thead>
			<tbody>
				<tr th:each="dto, i : ${weatherlist}">
 				<td th:text="${paging.listtotal - ((paging.current-1)* paging.onepagelist)   -  i.index}"></td>
			   <!-- <td th:text="${list.size()-i.index}"></td> -->
					<td>
						<a th:href="@{/weather/weatherdetail(wid=${dto.wid})}"   
						   th:text="${dto.weather}"></a>
					</td>
					<td th:text="${dto.maxtemp}"></td>
					<td th:text="${dto.mintemp}"></td>
					<td th:text="${dto.moistpercent}"></td>
					<td th:text="${dto.rainpercent}"></td>
					<td th:text="${dto.basedate}"></td>
				</tr>
			</tbody>
		</table>
		<!-- UtilPaging(listtotal=193, onepagelist=10, pagetotal=20, bottomlist=10, pstartno=0, current=1, start=1, end=10) -->
		<nav  th:if="${paging!=null}"  aria-label="Page navigation">
			<ul  class="pagination   justify-content-center">
			    <!--  1    -  이전(1)11     -  이전(11)21 -->
				<li  class="page-item"  th:if="${paging.start > 1}">
					<a 	class="page-link"
						th:href="@{/weather/weatherlist(pageNo=${paging.start - paging.bottomlist})}">이전</a>
				</li>
			    
			    <!-- 1,2,3,4,5,6,7,8,9,10 -->
				<li  class="page-item"
					th:each="pageNum :${#numbers.sequence(paging.start , paging.end)}"
				    th:classappend="${pageNum == paging.current} ? 'active' ">
					<a class="page-link"
					   th:href="@{/weather/weatherlist(pageNo=${pageNum})}"    
					   th:text="${pageNum}"></a>
				</li>
			    
			    <!--   10 다음(11)    20다음(21)  -->
				<li  class="page-item"  th:if="${paging.end < paging.pagetotal}">
					<a 	class="page-link"
						th:href="@{/weather/weatherlist(pageNo=${paging.start + paging.bottomlist})}">다음</a>
				</li>
			</ul>
		</nav>
		<!-- <div sec:authorize="isAuthenticated()"></div> -->
		<p class="text-end">
			<a th:href="@{/smart/smartlist}"
				class=" text-white btn btn-mustard">운동스마트게시판</a>
		</p>
		
		
		<!-- <div sec:authorize="isAuthenticated()"></div> -->
		<p class="text-end">
			<a th:href="@{/execapi/saveweather}"
				class=" text-white btn btn-warning">우리동네 단기예보</a>
		</p>
		
		
		<p class="text-end"> <a  th:href="@{/weather/weatherwrite}" class="btn btn-mint">글쓰기</a> </p>
		<p class="text-end alert alert-info">로그인을 하면 글쓰기가능합니다.</p> 
		
		<!-- 검색 part -->		
		<!-- 검색 part -->		 
		<div class="mb-3 mt-3 alert alert-info">
		  <label for="search" class="form-label">검색</label>
		  <input type="search" class="form-control" id="search" placeholder="검색어를 입력해주세요" name="search">
	
			<!--                    -->
			<!--                    -->
			<div id="resultArea">
				<table class="table table-striped table-bordered table-hover  my-3">
					<caption>검색결과</caption>
					<thead>
						<tr>
					    	<th scope="col">번호</th> 
							<th scope="col">날씨</th> <!-- 글상세보기 링크 -->
							<th scope="col">최고기온</th>
					   		<th scope="col">최저기온</th>
							<th scope="col">습도</th>
					   		<th scope="col">강수량</th>
						</tr>
					</thead>
					<tbody>
						<!-- AJAX 결과가 여기에 들어감 -->
					</tbody>
				</table>
				<!-- 페이징 버튼 영역 -->
		    	<div id="pagingArea" class="mt-2 text-center"  ></div>
			</div>
		</div>
			<!-- 검색 part -->		
		<!-- 검색 part -->			
		<script>
		$(function(){
			////////////////////////////////////////
			//#1. 검색어 입력이벤트
			$("#search").on("keyup" ,  function(){
				let keyword = $(this).val().trim();
				console.log(".... " + keyword);
				
				if(keyword === ""){
					$("#resultArea  tbody") 
						.empty()
						.append("<tr><td colspan='5'>검색어를 입력해주세요.</td></tr>");
					$("#pagingArea").empty();
				}
				else{ loadPage(keyword , 1); } // 검색시 첫페이지 부터 로드
			});

			////////////////////////////////////////
			//#2. 페이징처리
			function loadPage(keyword, pageNo){
				$.ajax({
					url:"search" , 
					type:"GET" , 
					data: {keyword : keyword , pageNo : pageNo} , 
					success:function(res){
						//console.log( res );
						//1. 결과 리스트출력
						$("#resultArea  tbody").empty();
						$.each( res.list , function(  index, dto){  
							let no  = res.paging.listtotal-((res.paging.current-1)*res.paging.onepagelist) - index; 
							let row = `
							   <tr>
									<td>${dto.wid}</td>
									<td><a href="weatherdetail?wid=${dto.wid}">${dto.weather}</a></td>
									<td>${dto.maxtemp}</td>
									<td>${dto.mintemp}</td>
									<td>${dto.moistpercent}</td>
									<td>${dto.rainpercent}</td>
							   </tr>
							`;  //템플릿리터럴
							$("#resultArea  tbody").append(row);
						});

						///////////////////////////////////////////////////////////
						//2. 페이징버튼
						let  pagingHtml = "";
						
						if( res.paging.start > 1 ){
							pagingHtml += 
								`<button class="btn btn-sm  btn-outline-primary pageBtn" data-page="${res.paging.start-1}">이전</button>`;
						}
						
						for(let i=res.paging.start ; i <= res.paging.end; i++){
							const active =  i === res.paging.current ? "btn-primary" : "btn-outline-primary";
							pagingHtml += `<button class="btn btn-sm ${active} pageBtn"  data-page="${i}" >${i}</button>`;
						}
						
						if( res.paging.end < res.paging.pagetotal ){
							pagingHtml += 
								`<button class="btn btn-sm  btn-outline-primary pageBtn" data-page="${res.paging.end+1}">다음</button>`;
						}
						
						
						$("#pagingArea").html(pagingHtml);

						///////////////////////////////////////////////////////////
						//3. 동적요소에 버튼클릭 이벤트 위임.
						$(document).on("click" , ".pageBtn" , function(){
							const newPage = $(this).data("page");
							const keyword = $("#search").val();
							loadPage(keyword, newPage);
						});
						///////////////////////////////////////////////////////////
					},
					error : function( xhr, status, error  ){   
						console.log("status : " + status);  //요청상태 (error, timeout......)
						console.log("error  : " + error);   // 에러메시지
						console.log("xhr    : " + xhr.responseText); // 서버반환내용
					}
				});
			}
		});	
		</script>	
		<!-- 검색 part -->		
		<!-- 검색 part -->	
	</div>
</div>
	<!--    http://localhost:8484/pawject3/weather/weatherlist -->
</body>
</html>