<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{fragments/layout}">
<head lang="ko">
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
	<div layout:fragment="content">


    <h2 class="foodsearcher-title">사료 찾기</h2>
    
    <div class="filterbox">
    
		<div class="filter-row row">

			<div class="pettypeidfilter col-4 mb-2">
				<select name="pettypeid" id="pettypeid" class="form-control" >
					<option value="">-- 모든 펫타입 --</option>
					<option value="1">고양이</option>
					<option value="2">강아지</option>
				</select>
			</div>

			<div class="foodtypefilter col-4 mb-2">
				<select name="foodtype"	id="foodtype" class="form-control">
					<option value="">-- 건식/습식 --</option>
					<option value="건식">건식</option>
					<option value="습식">습식</option>
				</select>
			</div>

			<div class="brandidfilter col-4 mb-2">
			  <select name="brandid" id="brandid" class="form-control">
			    <option value="">-- 모든 브랜드 --</option>	
			    <option th:each="b : ${brandlist}"
			            th:value="${b.brandid}"
			            th:text="${b.brandname}">
			    </option>
			  </select>
			</div>
			
			<div class="foodidfilter col-4 mb-2">
			  <select name="foodid" id="foodid" class="form-control">
			    <option value="">-- 모든 사료 --</option>	
			    <option th:each="f : ${foodlist}"
			    		th:data-pet="${f.pettypeid}"
			    		th:data-brand="${f.brandid}"
			            th:value="${f.foodid}"
			            th:text="${f.foodname}">
			    </option>
			  </select>

			</div>
		</div>
		
		<div class="filter-row row">	
		  <div class="col d-flex justify-content-center gap-2">
		    <input type="text" id="keyword"
		           placeholder="찾으시는 사료나 재료를 입력해 주세요"
		           class="form-control" style="width:300px;">
		    <button type="button" class="btn btn-mint" onclick="searchPetfood()">검색</button>
		  </div>
		</div>
		
		<div class="row">
		  <div class="col d-flex justify-content-end gap-2">
		    <button type="button"
		            id="searchFilterToggle"
		            onclick="toggleContent()"
		            class="btn btn-mint">
		      상세조건
		    </button>
		  </div>
		</div>		
		
		<!-- 여기가 토글 -->
		<div id="searchFilterPanel" class="hidden">

	  		<div class="filter-row row">	
				<div class="categoryfilter col-3 mb-2">
					<select name="category" id="category" class="form-control">
						<option value="">-- 모든 유형 --</option>
						<option value="일반">일반</option>
						<option value="처방식">처방식</option>
						<option value="기능식">기능식</option>
					</select>
				</div>
	
				<div class="petagegroupfilter col-3 mb-2">
					<select name="petagegroup" id= "petagegroup" class="form-control">
						<option value="">-- 모든 연령 --</option>
						<option value="어덜트">어덜트</option>
						<option value="시니어">시니어</option>
						<option value="키튼">키튼</option>
						<option value="퍼피">퍼피</option>
					</select>
				</div>
	
				<div class="isgrainfreefilter col-3 mb-2">
					<select name="isgrainfree" id="isgrainfree" class="form-control">
						<option value="">-- 그레인프리?--</option>
						<option value="Y">Y</option>
						<option value="N">N</option>
					</select>
				</div>
				
				<div class="originfilter col-3 mb-2">
					<select name="origin" id="origin" class="form-control">
						<option value="">-- 국내/해외 --</option>
						<option value="국내">국내</option>
						<option value="해외">해외</option>
					</select>
				</div>	

			</div>
			
		<div class="filter-row row">	

		  <div class="rangelabelfilter col-3 mb-2">
		    <select name="rangeid" id="rangeid" class="form-control">
		      <option value="">-- 영양소 범위 --</option>	
		      <option th:each="r : ${rangelist}"
		              th:data-pet="${r.pettypeid}"
		              th:value="${r.rangeid}"
		              th:text="${r.rangelabel}">
		      </option>
		    </select>
		  </div> 
		  
		<div class="caloriefilter col-8 mb-2">
		  <div class="input-group">
		    <span class="input-group-text">칼로리</span>
		    <input type="text" class="form-control" name="minvalue" placeholder="최소">
		    <span class="input-group-text">~</span>
		    <input type="text" class="form-control" name="maxvalue" placeholder="최대">
		    <span class="input-group-text">kcal</span>
		  </div>
		</div>	
			
		</div> <!-- filter-row -->
		
    </div><!-- searchFilterPanel -->

	</div><!-- filterbox -->	
	
	
	<!-- ai 상담 채팅창 -->
	<!-- ai 상담 채팅창 -->
	<!-- ai 상담 채팅창 -->
	
	
	
	
	<!-- 검색결과 -->
	<!-- SELECT B.BRANDNAME, F.FOODNAME , F.FOODIMG, R.AVGRATING, F.DESCRIPTION -->
	 <div>
	 
	<table class="resultTable">
	<input type="hidden" id="csrfHeader" th:value="${_csrf.headerName}">
	<input type="hidden" id="csrfToken"  th:value="${_csrf.token}">
	  <thead>
	    <tr>
	      <th scope="col">검색 결과</th>
	    </tr>
	  </thead>
	
	 <tbody id="resultBody"></tbody>

	</table>
	
	<!-- 페이징 -->
	<div id="pagingArea" class="mt-2 text-center"></div>
			 
	 
	 </div>

	

		<script>
		
		// 전역변수-토큰
		let csrfToken = $("#csrfToken").val();
		let csrfHeader = $("#csrfHeader").val();
		
		// 전역변수-페이징 화면 분기
		let currentMode = "list";
		let currentKeyword = "";
		let currentPageNo = 1;
		
		// 초기 로드 - 여기선 필요없음, 제거.
		
		//토글
		function toggleContent() {
			  const panel = document.getElementById("searchFilterPanel");
			  if (!panel) return;
			  panel.classList.toggle("hidden");
			}
			
		//페이징 버튼
		$(document).on("click", ".pageBtn", function(){
		  let page = $(this).data("page");
		
		  //여기 조심!
		  const params = cleanParams({
		    ...collectSearchParams(),
		    keyword: currentKeyword,
		    pstartno : page
		  });
		
		  doPetfoodSearch(params);
		});
		
		//검색필터
	    window.onload = function () {
	        const pet = document.getElementById("pettypeid");
	        const brand = document.getElementById("brandid");
	        const food = document.getElementById("foodid");
	        const range = document.getElementById("rangeid");

	        //펫타입+브랜드->사료
	        function filterFood() {
	          const p = pet.value;
	          const b = brand.value;

	          for (let i = 0; i < food.options.length; i++) {
	            const opt = food.options[i];

	            if (!opt.getAttribute("data-pet")) {
	              opt.style.display = "block";
	              continue;
	            }

	            const petOk = (p === "") || (opt.getAttribute("data-pet") === p);
	            const brandOk = (b === "") || (opt.getAttribute("data-brand") === b);

	            opt.style.display = (petOk && brandOk) ? "block" : "none";
	          }

	          food.value = "";
	        }
			//펫타입->라벨
	        function filterRange() {
	          const p = pet.value;

	          for (let i = 0; i < range.options.length; i++) {
	            const opt = range.options[i];

	            if (!opt.getAttribute("data-pet")) {
	              opt.style.display = "block";
	              continue;
	            }

	            const petOk = (p === "") || (opt.getAttribute("data-pet") === p);
	            opt.style.display = petOk ? "block" : "none";
	          }

	          range.value = "";
	        }

	        pet.onchange = function () {
	          filterFood();
	          filterRange();
	        };
	        brand.onchange = filterFood;
	      };
		
	
		//별점 표시
		function ratingToStar(avgrating) {
			  const r = Math.round(avgrating);

			  if (r === 5) return "★★★★★ (" + avgrating.toFixed(1) + ")";
			  if (r === 4) return "★★★★☆ (" + avgrating.toFixed(1) + ")";
			  if (r === 3) return "★★★☆☆ (" + avgrating.toFixed(1) + ")";
			  if (r === 2) return "★★☆☆☆ (" + avgrating.toFixed(1) + ")";
			  if (r === 1) return "★☆☆☆☆ (" + avgrating.toFixed(1) + ")";
			  return "☆☆☆☆☆";
			}
		
		//검색 - 파라미터 int 타입들 빈값 오류 방지
		function cleanParams(obj){
			  const result = {};
			  for (const key in obj) {
			    if (obj[key] !== "" && obj[key] !== null && obj[key] !== undefined) {
			      result[key] = obj[key];
			    }
			  }
			  return result;
			}
		// 파라미터 따로 빼주기
		function collectSearchParams() {
			  return {
			    keyword: document.getElementById("keyword")?.value.trim(),
			    pettypeid: document.getElementById("pettypeid")?.value,
			    foodtype: document.getElementById("foodtype")?.value,
			    brandid: document.getElementById("brandid")?.value,
			    foodid: document.getElementById("foodid")?.value,
			    category: document.getElementById("category")?.value,
			    petagegroup: document.getElementById("petagegroup")?.value,
			    isgrainfree: document.getElementById("isgrainfree")?.value,
			    origin: document.getElementById("origin")?.value,
			    rangeid: document.getElementById("rangeid")?.value,
			    minvalue: document.querySelector("input[name='minvalue']")?.value,
			    maxvalue: document.querySelector("input[name='maxvalue']")?.value
			  };
			}
		
		//검색 - 전체 스캔 방지
			function searchPetfood() {
	
			  const rawParams = collectSearchParams();  //전체 값
			  const params = cleanParams(rawParams);	//빈값 지우기
			
			  if (Object.keys(params).length === 0) {
			    alert("검색 조건을 하나 이상 선택해 주세요.");
			    return;
			  }
			  params.pstartno = 1;  //검색 페이지 여기서 설정해줘야됨
			  doPetfoodSearch(params);
			}
		 function doPetfoodSearch(params){

			 currentMode = "list";
			 currentKeyword = params.keyword || "";   //값이 빈 인자 존재
			 currentPageNo  = params.pstartno || 1;		// 그냥 currentKeyword = keyword 아렇게 받으면 터짐.
			  											// 컨트롤러 지저분한 것과 같슨
			  $.ajax({
			    url:"/petfoodsearcher/searchfilterPaging",
			    type:"GET",
			    data:params, 
			    beforeSend: function(xhr){
			      if(csrfHeader && csrfToken){
			        xhr.setRequestHeader(csrfHeader, csrfToken);
			      }
			    },

			    success: function(result){
			      const list = result.list;   // 빼먹지말기
			      const total = result.total;
			      
			      const $tbody = $("#resultBody");
			      $tbody.empty();

			      if(!list || list.length === 0){
			        $tbody.append(`
			          <tr>
			            <td>검색 결과가 없습니다.</td>
			          </tr>
			        `);
			        return;
			      }

			      list.forEach(function(f){

			        const imgSrc = f.foodimg ? `/foodimg/${f.foodimg}` : `/foodimg/brand0${f.brandid}.png`;

			        const row = `
			          <tr>
			            <td style="display:flex; align-items:flex-start; gap:16px;">
			              <img src="${imgSrc}"
			                   style="width:160px; height:160px; object-fit:cover; border-radius:12px;">
			              <div class="d-flex flex-column justify-content-between">
			                <div>
			                  <span class="rating">${ratingToStar(f.avgrating)}</span><br>
			                  <span class="brand">${f.brandname}</span><br>
			                  <span class="foodname">${f.foodname}</span><br>
			                  <span class="desc">${f.description}</span>
			                </div>
			                <div class="action">
				                
				        	<button class="btn btn-olive btn-sm"
						            onclick="window.open(
								              '/foodboard/fooddetail.fn?foodid=${f.foodid}',
								              'detailPopup',
								              'width=900,height=700,scrollbars=yes,resizable=yes'
								            )">
				        	상세보기</button> 
				        	
			        	<button class="btn btn-olive btn-sm"
					            onclick="window.open(
							              '/reviewboard/reviewlist?foodid=${f.foodid}',
							              'detailPopup',
							              'width=900,height=700,scrollbars=yes,resizable=yes'
							            )">
			        	리뷰</button> 	
	
			                 </div>
			              </div>
			            </td>
			          </tr>
			        `;

			        $tbody.append(row);
			      });
			      
			      
			      renderPaging(result.paging);  //페이징
			      
			      
			    },

			    error: function(){
			      alert("검색 중 오류가 발생했습니다.");
			    }
			    
			    
			  });
			}
		 
		 function renderPaging(p){
			  let area = $("#pagingArea");
			  area.empty();

			  if(!p || p.pagetotal <= 1) return;

			  let html = "";
			  let end = Math.min(p.end, p.pagetotal);

			  if(p.start > 1){
			    html += `<button class="btn btn-sm btn-outline-primary pageBtn" data-page="${p.start-1}">이전</button>`;
			  }

			  for(let i=p.start; i<=end; i++){
			    let active = (i === p.current) ? "btn-primary" : "btn-outline-primary";
			    html += `<button class="btn btn-sm ${active} pageBtn ms-2" data-page="${i}">${i}</button>`;
			  }

			  if(end < p.pagetotal){
			    html += `<button class="btn btn-sm btn-outline-primary pageBtn ms-2" data-page="${end+1}">다음</button>`;
			  }

			  area.html(html);
			}		 
		 
		</script>

	</div><!-- content-->
	



</body>
</html>