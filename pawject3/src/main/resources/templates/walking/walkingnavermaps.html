<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head lang="ko">
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
<div sec:authorize="isAuthenticated()">
   <div layout:fragment="content">
     <script type="text/javascript" 
             src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=m3jz1a155u&callback=initMap"></script>
     
     <h2 class="mb-3">ğŸ“ í˜„ì¬ ìœ„ì¹˜ ê¸°ë°˜ ì‚°ì±…ì½”ìŠ¤ ì¶”ì²œ</h2>
   
     <div class="mb-3">
       <button id="locateBtn" class="btn btn-primary me-2">ë‚´ ìœ„ì¹˜ ì°¾ê¸°</button>
       <button id="showAllBtn" class="btn btn-secondary">ëª¨ë“  ì‚°ì±…ì½”ìŠ¤ í‘œì‹œ</button>
     </div>
   
     <div id="map" class="border rounded" style="width:100%; height:500px;"></div>
   
     <div class="card mt-3">
       <div class="card-body">
         <h5 class="card-title"> ì‚°ì±… ì½”ìŠ¤ ì¶”ì²œ</h5>
         <p id="resultText" class="card-text">ì•„ì§ ìœ„ì¹˜ë¥¼ ì°¾ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
         <div id="storeList" class="list-group"></div>
       </div>
     </div>
		<!-- <div sec:authorize="isAthenticated()"></div> -->
		<p class="text-end">
			<a th:href="@{/smart/smartlist}"
				class=" text-white btn btn-mustard">ìš´ë™ìŠ¤ë§ˆíŠ¸ê²Œì‹œíŒ</a>
		</p>

		<!-- <div sec:authorize="isAthenticated()"></div> -->
		<p class="text-end">
			<a th:href="@{/walking/walkinglist}"
				class=" text-white btn btn-primary">ì‚°ì±…ì½”ìŠ¤ì¶”ì²œ</a>
		</p>


    <script th:inline="javascript">
       let map;
       let userMarker;
       let walking;

       function initMap(){
           const location = [[${location}]];
           const lat = [[${lat}]];
           const lng = [[${lng}]];

           walking = [
               { name : "ì¸ì²œëŒ€ê³µì›", lat : 37.459267, lng : 126.750511 },
               { name : "ë¶í•œì‚°ë‘˜ë ˆê¸¸ - 1ì½”ìŠ¤ ì†Œë‚˜ë¬´ìˆ²ê¸¸", lat : 37.6630, lng : 127.0115 },
               { name : "ë°˜í¬í•œê°•ê³µì›", lat : 37.5100, lng : 126.9950 },
               { name: location, lat: lat, lng: lng }
           ];

           map = new naver.maps.Map('map', {
               center: new naver.maps.LatLng(37.3595704, 127.105399),
               zoom: 15
           });

           userMarker = new naver.maps.Marker({
               position: new naver.maps.LatLng(37.3595704, 127.105399),
               zIndex:9999, map: map
           });

           document.getElementById("locateBtn").onclick = Recomment;
           document.getElementById("showAllBtn").onclick = showWalkingCourse;
       }

       function showWalkingCourse(){
           walking.forEach(course => {
               const pos = new naver.maps.LatLng(course.lat, course.lng);
               new naver.maps.Marker({position:pos, map});
           });
           map.setZoom(10);
           document.getElementById("resultText").textContent="ëª¨ë“  ì‚°ì±…ì½”ìŠ¤ë¥¼ í‘œì‹œí–ˆìŠµë‹ˆë‹¤.";
       }

       function haversine(lat1, lng1, lat2, lng2) {
           const R = 6371;
           const toRad = deg => deg * Math.PI / 180;
           const dLat = toRad(lat2 - lat1);
           const dLng = toRad(lng2 - lng1);
           const a = Math.sin(dLat/2)**2 +
                     Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                     Math.sin(dLng/2)**2;
           return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
       }

       function Recomment(){
           if(!navigator.geolocation){
               alert("ë¸Œë¼ìš°ì €ê°€ ìœ„ì¹˜ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
               return;
           }
           navigator.geolocation.getCurrentPosition(pos => {
               const lat = pos.coords.latitude;
               const lng = pos.coords.longitude;
               const userPos = new naver.maps.LatLng(lat, lng);

               userMarker.setPosition(userPos);
               userMarker.setMap(map);
               map.setCenter(userPos);

               let nearest = null;
               walking.forEach(course => {
                   const dist = haversine(lat, lng, course.lat, course.lng);
                   if(!nearest || dist < nearest.dist){
                       nearest = { ...course, dist };
                   }
               });

               if(nearest){
                   document.getElementById("resultText").innerHTML =
                       `ê°€ì¥ ê°€ê¹Œìš´ ì‚°ì±…ì½”ìŠ¤ : <span class="text-primary fw-bold">${nearest.name}</span> (${nearest.dist.toFixed(2)} km)`;

                   document.getElementById("storeList").innerHTML =
                       walking.map(w=>{
                           const d = haversine(lat, lng, w.lat, w.lng).toFixed(2);
                           const activeClass = w.name === nearest.name ? "active" : "";
                           return `<div class="list-group-item ${activeClass}">${w.name} - ${d} km</div>`;
                       }).join("");
               }
           });
       }
    </script>
   </div>
</div>   
</body>
</html>