<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{fragments/layout}">
<head lang="ko">
<meta charset="UTF-8">
<title>사료 정보</title>
</head>
<body>
	<div layout:fragment="content">
 
<script th:inline="javascript">
    const csrfHeader = /*[[${_csrf.headerName}]]*/ '';
    const csrfToken  = /*[[${_csrf.token}]]*/ '';
</script>


<div class="container my-5">

    <div class="card p-4 shadow-sm foodTable">

        <h3 class="card-header mb-3">사료 정보</h3>

        <table class="table table-hover text-center align-middle">
			<caption class="visually-hidden">사료 관리자 페이지</caption>
			
		<div class="d-flex justify-content-end mb-2 mt-3" id="conditionWrap">
		  <select id="condition" class="condition form-select form-select-sm" style="width:120px;">
		    <option value="">최신</option>
		    <option value="foodnameAsc">사료명</option>
		    <option value="foodnameDesc">사료역순</option>
		    <option value="brandnameAsc">브랜드명</option>
		    <option value="brandnameDesc">브랜드역순</option>
		  </select>
		</div>
            <thead class="table-light">
                <tr>
                    <th scope="col">NO</th>
                    <th scope="col">펫타입</th>
                    <th scope="col">브랜드</th> 
                    <th scope="col">사료명</th>
                    <th scope="col">등록일</th>
                    <th scope="col">수정일</th>
                    <th scope="col">빠른삭제</th>
                </tr>
 
            </thead>

            <tbody>
            </tbody>   
		</table>

			<div class="row my-3">
			  <div class="col d-flex justify-content-center gap-2">
			    <select id="searchType" class="form-select" style="width:150px;">
			      <option value="all">전체</option>
			      <option value="pettypeid">강아지/고양이</option>
			      <option value="brandname">브랜드명</option>
			      <option value="foodname">사료명</option>
			    </select>
			
			    <input type="text" id="searchKeyword" placeholder="검색어 입력" class="form-control" style="width:300px;">
			    <button class="btn btn-mint" onclick="searchFood()">검색</button>
			
			    <!-- 목록보기 버튼도 같은 flex 컨테이너 안에 -->
			    <a th:href="@{/foodboard/foodlist.fn}"
			       id="searchlistBtn"
			       class="btn btn-slateBlue"
			       style="display:none;">목록보기</a>
			  </div>
			</div>



		

		<div id="pagingArea" class="mt-2 text-center"  ></div>

        <div class="text-end">
            <a th:href="@{/foodboard/foodwrite.fn}"
            	id="writeBtn"
               class="btn btn-slateBlue">사료 등록</a>
        </div>
	<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
    </div>
</div>

<script>
// 전역변수-페이징 화면 분기
let currentMode = "list";
let currentSearchType = "";
let currentKeyword = "";
let currentPageNo = 1;

//전역변수-정렬
let currentCondition = null;  

// 첫 로딩
// 초기 로드
$(function(){
  foodPaging(1);
});

//페이징 버튼
$(document).on("click", ".pageBtn", function(){
  let page = $(this).data("page");
  currentPageNo = page;

  if(currentMode === "search"){
	  doFoodSearch(currentSearchType, currentKeyword, page);
  } else {
    foodPaging(page);
  }
});

//답변 상태 정렬
$(document).on("change", ".condition", function () {
    currentCondition = $(this).val() || null;
    currentPageNo = 1;

    if (currentMode === "search") {
        doFoodSearch(currentSearchType, currentKeyword, 1);
    } else {
        foodPaging(1);
    }
});

//전체 리스트 페이지
function foodPaging(pageNo) {
    currentMode = "list";
    currentPageNo = pageNo;
    
    let data = { pageNo : pageNo };
    if (currentCondition) data.condition = currentCondition;	
    
    $.ajax({
        url: "/foodboard/foodselectForList",
        type: "GET",
        data: data,
        success: function(json){	
        	
            console.log(json);           // 전체 확인
            console.log(json.paging);    // 페이징 확인
            foodPagingResult(json, pageNo);
            renderPaging(json.paging);
        	
        	
          foodPagingResult(json, pageNo);
          renderPaging(json.paging);
          $("#searchlistBtn").hide();   
        }
      });
    }

//검색
function searchFood(){
    const keyword = $("#searchKeyword").val().trim();
    const searchType = $("#searchType").val();

    if(keyword.length === 0){
        alert("검색어를 입력해주세요.");
        return;
    }

    doFoodSearch(searchType, keyword, 1);
}



function doFoodSearch(searchType, keyword, pageNo){
	  currentMode = "search";
	  currentSearchType = searchType;
	  currentKeyword = keyword;
	  currentPageNo = pageNo;

	  let data = {
			  searchType: searchType,
			  keyword: keyword,
			  pageNo: pageNo
			};
	  if (currentCondition) data.condition = currentCondition;
	  
    $.ajax({
        url: "/foodboard/foodsearch",
        type: "GET",
        data: data,
        success: function(json){
            if(!json.list || json.list.length === 0){
              alert("검색 결과가 없습니다.");
              return;
            }

            foodPagingResult(json, pageNo);
            renderPaging(json.paging);
            $("#searchlistBtn").show();   
          }
        });
      }
     
//페이징 결과
function foodPagingResult(json, pageNo) {

    let list = json.list;
    let total = json.total;
    let tbody = $(".foodTable tbody");
    tbody.empty();
    
    if(!list || list.length === 0){
        tbody.append('<tr><td colspan="7">검색 결과가 존재하지 않습니다.</td></tr>');
        return;
      }
    
    $.each(list, function(idx, food) {
        let number = total - ((pageNo - 1) * 10 + idx);

        $("<tr>")
            .append($("<td>").text(number))
            .append($("<td>").text(pettypename(food.pettypeid)))
            .append($("<td>").text(food.brandname))
			.append($("<td>").html(
			  "<a href='/foodboard/fooddetail.fn?foodid=" + food.foodid + 
			  "' style='text-decoration:none; color:black; font-weight:bold;'>" +
			  food.foodname + "</a>"
			))
            .append($("<td>").text(food.createdat))
            .append($("<td>").text(food.updatedat))
            .append($("<td>").html(
                "<button class='btn btn-roseRed foodquikdelete' data-foodid='" +
                food.foodid + "'>빠른삭제</button>"
            ))
            .appendTo(".foodTable tbody");
    });
}

//페이징 랜더
function renderPaging(p){
  let area = $("#pagingArea");
  area.empty();

  if(!p || p.pagetotal <= 1) return;

  let html = "";
  let end = Math.min(p.end, p.pagetotal);

  if(p.start > 1){
    html += `<button class="btn btn-sm btn-outline-primary pageBtn" data-page="${p.start-1}">이전</button>`;
  }

  for(let i=p.start; i<=end; i++){
    let active = (i === p.current) ? "btn-primary" : "btn-outline-primary";
    html += `<button class="btn btn-sm ${active} pageBtn ms-2" data-page="${i}">${i}</button>`;
  }

  if(end < p.pagetotal){
    html += `<button class="btn btn-sm btn-outline-primary pageBtn ms-2" data-page="${end+1}">다음</button>`;
  }

  area.html(html);
}

//빠른 삭제
$(document).on("click", ".foodquikdelete", function () {

    let foodid = $(this).data("foodid");
    let currentPage = $("#currentPage").val() || 1;

    if (!confirm("삭제하시겠습니까?")) return;

    $.ajax({
        url: "/foodboard/foodquikdelete",
        type: "POST",
        beforeSend: function(xhr) {
            xhr.setRequestHeader(csrfHeader, csrfToken);
        },
        data: { foodid: foodid },
        success: function() {
            if (currentMode === "search") {
                doFoodSearch(currentSearchType, currentKeyword, currentPageNo);
            } else {
                foodPaging(currentPageNo);
            }
        },
        error: function() {
            alert("error");
        }
    });
});

function pettypename(pettypeid){
    if(pettypeid == 1) return "고양이";
    else if(pettypeid == 2) return "강아지";    
}
</script>
 
	</div><!-- content-->
</body>
</html>