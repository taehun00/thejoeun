<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{fragments/layout}">
<head lang="ko">
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
	<div layout:fragment="content">
 
<script>
    const csrfHeader = "${_csrf.headerName}";
    const csrfToken = "${_csrf.token}";
</script>


<div class="container my-5">

    <div class="card p-4 shadow-sm foodTable">

        <h3 class="card-header mb-3">사료 정보</h3>

        <table class="table table-hover text-center align-middle">
        <input type="hidden" id="currentPage" th:value="${foodpaging.pstartno}">
			<caption class="visually-hidden">사료 관리자 페이지</caption>
            <thead class="table-light">
                <tr>
                    <th scope="col">NO</th>
                    <th scope="col">펫타입</th>
                    <th scope="col">브랜드</th> 
                    <th scope="col">사료명</th>
                    <th scope="col">등록일</th>
                    <th scope="col">수정일</th>
                    <th scope="col">빠른삭제</th>
                </tr>

                
                
            </thead>

            <tbody>
            </tbody>   
		<tfoot>
		<tr>
		<td colspan="7">
			<ul class="pagination justify-content-center">
			
			  <!-- 이전 -->
			  <li class="page-item"
			      th:if="${foodpaging.start > 10}">
			      
			    <a href="#" class="page-link"
			       th:onclick="|foodList(${foodpaging.start - 1})|">이전</a>

			  </li>
			
			  <!-- 페이지 숫자 -->
			  <li class="page-item"
			      th:each="i : ${#numbers.sequence(foodpaging.start, foodpaging.end)}"
			      th:classappend="${i == foodpaging.current} ? 'active'">
			    <a href="#" class="page-link"
			       th:onclick="|foodList(${i})|"
			       th:text="${i}">1</a>
			  </li>
			
			  <!-- 다음 -->
			  <li class="page-item"
			      th:if="${foodpaging.pagetotal > foodpaging.end}">
			    <a href="#" class="page-link"
			       th:onclick="|foodList(${foodpaging.end + 1})|">다음</a>
			  </li>
			
			</ul>
		</td>
		</tr>
		</tfoot>
		</table>

			<div class="row my-3">
			  <div class="col d-flex justify-content-end gap-2">
			    <select id="searchType" class="form-select" style="width:150px;">
			      <option value="all">전체</option>
			      <option value="pettypeid">강아지/고양이</option>
			      <option value="brandname">브랜드명</option>
			      <option value="foodname">사료명</option>
			    </select>
			
			    <input type="text" id="searchKeyword" placeholder="검색어 입력" class="form-control" style="width:300px;">
			    <button class="btn btn-mint" onclick="searchFood()">검색</button>
			
			    <!-- 목록보기 버튼도 같은 flex 컨테이너 안에 -->
			    <a th:href="@{/foodboard/foodlist.fn}"
			       id="searchlistBtn"
			       class="btn btn-slateBlue"
			       style="display:none;">목록보기</a>
			  </div>
			</div>



		

		<div id="pagingArea" class="mt-3"></div>

        <div class="text-end">
            <a th:href="@{/foodboard/foodwrite.fn}"
            	id="writeBtn"
               class="btn btn-slateBlue">사료 등록</a>
        </div>
	<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
    </div>
</div>

<script>
// 전역 상태
let currentMode = "list";       
let currentSearchType = "";
let currentKeyword = "";

// 첫 로딩
$(function() {
    const currentPage = $("#currentPage").val() || 1;
    foodList(currentPage);
    foodquikdelete();
});


function doFoodSearch(searchType, keyword){
    currentMode = "search";
    currentSearchType = searchType;
    currentKeyword = keyword;

    $.ajax({
        url: "/foodboard/foodsearch",
        type: "GET",
        data: { keyword: keyword, searchType: searchType },
        success: function(json){

            // 검색 결과 출력 + 목록보기 버튼
            foodListResult(json, 1);
            $("#searchlistBtn").show();
            // 검색 모드에서는 JSP 페이징 숨김
            $("tfoot").hide();
            $("#writeBtn").hide();
        }
    });
}

function searchFood(){
    const keyword = $("#searchKeyword").val().trim();
    const searchType = $("#searchType").val();

    if(keyword.length === 0){
        alert("검색어를 입력해주세요.");
        return;
    }

    doFoodSearch(searchType, keyword);
}


function foodList(pstartno = 1) {
    currentMode = "list";

    $.ajax({
        url: "/foodboard/foodselectForList",
        type: "GET",
        data: { pstartno: pstartno },
        success: function(json) {

            // 리스트 출력
            foodListResult(json, pstartno);
            // JSP 페이징 다시 보이게
            $("tfoot").show();
        },
        error: function() {
            alert("목록 불러오기 실패");
        }
    });
}


function foodListResult(json, pstartno) {

    let list = json.list;
    let total = json.total;

    $(".foodTable tbody").empty();

    $.each(list, function(idx, food) {
        let number = total - ((pstartno - 1) * 10 + idx);

        $("<tr>")
            .append($("<td>").text(number))
            .append($("<td>").text(pettypename(food.pettypeid)))
            .append($("<td>").text(food.brandname))
			.append($("<td>").html(
			  "<a href='/fooddetail.fn?foodid=" + food.foodid + 
			  "' style='text-decoration:none; color:black; font-weight:bold;'>" +
			  food.foodname + "</a>"
			))
            .append($("<td>").text(food.createdat))
            .append($("<td>").text(food.updatedat))
            .append($("<td>").html(
                "<button class='btn btn-mint foodquikdelete' data-foodid='" +
                food.foodid + "'>빠른삭제</button>"
            ))
            .appendTo(".foodTable tbody");
    });
}


function foodquikdelete() {
    $("body").on("click", ".foodquikdelete", function() {

        let foodid = $(this).data("foodid");
        let currentPage = $("#currentPage").val() || 1;

        if (confirm("삭제하시겠습니까?")) {
            $.ajax({
                url: "/foodboard/foodquikdelete",
                type: "POST",
                beforeSend: function(xhr) {
                    xhr.setRequestHeader(csrfHeader, csrfToken);
                },
                data: {
                    foodid: foodid,
                    pstartno: currentPage
                },
                success: function() {
                    foodList(currentPage); 
                },
                error: function() {
                    alert("error");
                }
            });
        }
    });
}

function pettypename(pettypeid){
    if(pettypeid == 1) return "고양이";
    else if(pettypeid == 2) return "강아지";    
}
</script>
 
	</div><!-- content-->
</body>
</html>