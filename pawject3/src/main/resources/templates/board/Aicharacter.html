
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head lang="ko">
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <title>ë°˜ë ¤ë™ë¬¼ ìºë¦­í„° ìƒì„±</title>

    <style>
  /* í•˜ë‹¨ ê²°ê³¼ ì˜ì—­ */
  .bottom-preview {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      display: flex;
      gap: 20px;
      z-index: 1000;
  }

  /* ì¢Œ/ìš° ê· ë“± */
  .preview-box {
      flex: 1;                 /* âœ… ê· ë“± ë¶„ë°° */
      background: #fff;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      text-align: center;
      min-width: 0;
  }

  .preview-title {
      font-weight: bold;
      margin-bottom: 8px;
  }

  /* âœ… ì´ë¯¸ì§€ í‘œì‹œ ì˜ì—­ ê³ ì • (ì¢Œ/ìš° ë™ì¼ ë†’ì´) */
  .img-frame {
      width: 100%;
      height: 280px;           /* âœ… ê³ ì • ë†’ì´ */
      border: 1px solid #eee;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background: #fafafa;
  }

  .img-frame img {
      width: 100%;
      height: 100%;
      object-fit: contain;     /* âœ… ë¹„ìœ¨ ìœ ì§€ */
  }

  #errorBox { margin-top: 12px; }
  #errorMessage { font-size: 14px; line-height: 1.4; }

  .loading-spinner {
      width: 60px;
      height: 60px;
      border: 6px solid #e0e0e0;
      border-top: 6px solid #4a90e2;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 40px auto;
  }

  @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
  }

  .hidden { display: none; }
</style>

    
</head>

<body>
<div layout:fragment="content" class="container mt-4">

    <!-- í˜ì´ì§€ ì œëª© -->
    <h3 class="card-header mb-3">ğŸ¾ ë°˜ë ¤ë™ë¬¼ ìºë¦­í„° ìƒì„±</h3>

    <!-- ìºë¦­í„° ìƒì„± í¼ -->
    <form id="petForm" method="post" enctype="multipart/form-data">
        <div class="mb-3">
            <label for="file" class="form-label">ì›ë³¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ:</label>
            <input type="file" class="form-control" id="file" name="file"
                   accept="image/*" onchange="previewUploadImage(this)">
        </div>

        <div class="mb-3">
            <label for="kindpet" class="form-label">ë°˜ë ¤ë™ë¬¼ ì¢…:</label>
            <input type="text" class="form-control" id="kindpet" name="kindpet"
                   placeholder="ì˜ˆ: ê°•ì•„ì§€, ê³ ì–‘ì´ ë“±">
        </div>

        <div class="mb-3">
            <label for="userid" class="form-label">ì‚¬ìš©ì ID:</label>
            <input type="number" class="form-control" id="userid" name="userid"
                   placeholder="ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        </div>

        <div class="text-end">
            <button type="button" class="btn btn-primary"
                    onclick="generatePetCharacter()">ìºë¦­í„° ìƒì„±</button>
        </div>
    </form>

<!-- ğŸ”½ í•˜ë‹¨ ì´ë¯¸ì§€ ì˜ì—­ -->
<!-- <div class="bottom-preview"> -->

    <!-- ì¢Œì¸¡: ì—…ë¡œë“œ ì´ë¯¸ì§€ -->
    <div class="preview-box">
        <div class="preview-title">ğŸ“· ì—…ë¡œë“œ ì´ë¯¸ì§€</div>
        <!-- <img id="uploadPreview" src="" alt="ì—…ë¡œë“œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°"> -->
        <div class="img-frame">
  			<img id="uploadPreview" src="" alt="ì—…ë¡œë“œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°">
		</div>
    </div>

   <!-- ìš°ì¸¡: AI ìƒì„± ì´ë¯¸ì§€ -->
<div class="preview-box">
  <div class="preview-title">ğŸ¨ AI ìºë¦­í„° ì´ë¯¸ì§€</div>

  <div class="img-frame">
    <!-- ë¡œë”© -->
    <div id="loading" class="loading-spinner hidden"></div>

    <!-- ê²°ê³¼ ì´ë¯¸ì§€ -->
    <img id="aiResultImage" src="" alt="AI ìƒì„± ì´ë¯¸ì§€" class="hidden">
  </div>

  <!-- ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ (ì„±ê³µ ì‹œ í‘œì‹œ) -->
  <div class="mt-2">
    <button id="downloadBtn" type="button" class="btn btn-success btn-sm hidden"
            onclick="downloadAiImage()">â¬‡ï¸ ë‹¤ìš´ë¡œë“œ</button>
  </div>

  <!-- ì‹¤íŒ¨ ë©”ì‹œì§€ -->
  <div id="errorBox" class="hidden">
    <p id="errorMessage" class="text-danger mb-2"></p>
    <button type="button" class="btn btn-outline-danger btn-sm"
            onclick="retryGenerate()">ğŸ” ì¬ì‹œë„</button>
  </div>
</div>




<!-- </div> -->

<!-- JS ë¡œì§ -->
<script>
/** =========================
 *  State (ì „ì—­)
 *  ========================= */
let lastFormData = null;      // ì¬ì‹œë„ìš©
let lastAiImageUrl = null;    // blob URL ì €ì¥(ë‹¤ìš´ë¡œë“œ/ë¯¸ë¦¬ë³´ê¸°ìš©)
let isGenerating = false;     // ì¤‘ë³µ ìš”ì²­ ë°©ì§€

/** =========================
 *  Helpers
 *  ========================= */
function getCsrf() {
  const tokenEl = document.querySelector('meta[name="_csrf"]');
  const headerEl = document.querySelector('meta[name="_csrf_header"]');
  return {
    token: tokenEl ? tokenEl.content : "",
    header: headerEl ? headerEl.content : ""
  };
}

function $(id) {
  return document.getElementById(id);
}

function setHidden(el, hidden) {
  if (!el) return;
  el.classList.toggle("hidden", hidden);
}

function setButtonLoading(isLoading) {
  const btn = document.querySelector('button[onclick="generatePetCharacter()"]');
  if (!btn) return;

  btn.disabled = isLoading;
  btn.innerText = isLoading ? "ìƒì„± ì¤‘..." : "ìºë¦­í„° ìƒì„±";
}

/** =========================
 *  Preview (ì—…ë¡œë“œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°)
 *  ========================= */
function previewUploadImage(input) {
  if (input.files && input.files[0]) {
    const url = URL.createObjectURL(input.files[0]);
    $("uploadPreview").src = url;
  }
}

/** =========================
 *  FormData
 *  ========================= */
function createFormData() {
  const fileInput = $("file");
  const kindpet = $("kindpet").value.trim();
  const userid = $("userid").value.trim();

  if (!userid) throw new Error("ì‚¬ìš©ì IDê°€ ì—†ìŠµë‹ˆë‹¤.");
  if (!kindpet) throw new Error("ë°˜ë ¤ë™ë¬¼ ì¢…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
  if (!fileInput.files || fileInput.files.length === 0) throw new Error("ì›ë³¸ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.");

  const fd = new FormData();
  fd.append("userid", userid);
  fd.append("kindpet", kindpet);
  fd.append("file", fileInput.files[0]); // âœ… keyëŠ” ë°˜ë“œì‹œ "file"

  return fd;
}

/** =========================
 *  Main: ìƒì„± ìš”ì²­ (PNG bytes ì‘ë‹µ)
 *  ========================= */
async function generatePetCharacter(formDataOverride) {
  // ì¤‘ë³µ í´ë¦­ ë°©ì§€
  if (isGenerating) return;
  isGenerating = true;
  setButtonLoading(true);

  const loading = $("loading");
  const aiImage = $("aiResultImage");
  const errorBox = $("errorBox");
  const errorMessage = $("errorMessage");
  const downloadBtn = $("downloadBtn");

  // UI ì´ˆê¸°í™”
  setHidden(loading, false);
  setHidden(aiImage, true);
  setHidden(errorBox, true);
  setHidden(downloadBtn, true);
  errorMessage.innerText = "";

  // ê¸°ì¡´ ì´ë¯¸ì§€ URL ì •ë¦¬(ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€)
  if (lastAiImageUrl && lastAiImageUrl.startsWith("blob:")) {
    URL.revokeObjectURL(lastAiImageUrl);
    lastAiImageUrl = null;
  }
  aiImage.src = "";

  const { token, header } = getCsrf();
  const formData = formDataOverride || createFormData();
  lastFormData = formData;

  try {
    const res = await fetch("/api/pet/character", {
      method: "POST",
      headers: header ? { [header]: token } : {},
      body: formData
    });

    if (!res.ok) {
      const errText = await res.text().catch(() => "");
      throw new Error(errText || `ìš”ì²­ ì‹¤íŒ¨ (${res.status})`);
    }

    // âœ… PNG ë°”ì´ë„ˆë¦¬ ì‘ë‹µ â†’ blob ì²˜ë¦¬
    const blob = await res.blob();

    // ì‘ë‹µì´ PNGì¸ì§€ 1ì°¨ ì²´í¬(ì„œë²„ì—ì„œ í…ìŠ¤íŠ¸ ì—ëŸ¬ë¥¼ ë‚´ë ¤ì£¼ëŠ” ê²½ìš° ë°©ì–´)
    if (blob.type && blob.type !== "image/png") {
      const maybeText = await blob.text().catch(() => "");
      throw new Error(maybeText || `PNGê°€ ì•„ë‹Œ ì‘ë‹µì…ë‹ˆë‹¤: ${blob.type}`);
    }

    const blobUrl = URL.createObjectURL(blob);
    lastAiImageUrl = blobUrl;

    aiImage.src = blobUrl;
    setHidden(aiImage, false);
    setHidden(downloadBtn, false);

  } catch (e) {
    errorMessage.innerText = e.message || "ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
    setHidden(errorBox, false);
  } finally {
    setHidden(loading, true);
    isGenerating = false;
    setButtonLoading(false);
  }
}

/** =========================
 *  Retry
 *  ========================= */
function retryGenerate() {
  if (lastFormData) generatePetCharacter(lastFormData);
}

/** =========================
 *  Download (blob URLë¡œ ì¦‰ì‹œ ë‹¤ìš´ë¡œë“œ)
 *  ========================= */
function downloadAiImage() {
  if (!lastAiImageUrl) {
    alert("ë‹¤ìš´ë¡œë“œí•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const a = document.createElement("a");
  a.href = lastAiImageUrl;
  a.download = "pet_character.png";
  document.body.appendChild(a);
  a.click();
  a.remove();
}
</script>








</div> 


</body>
</html>
