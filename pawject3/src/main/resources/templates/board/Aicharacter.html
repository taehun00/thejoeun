<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head lang="ko">
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <title>ë°˜ë ¤ë™ë¬¼ ìºë¦­í„° ìƒì„±</title>

    <style>
  /* í•˜ë‹¨ ê²°ê³¼ ì˜ì—­ */
  .bottom-preview {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      display: flex;
      gap: 20px;
      z-index: 1000;
  }

  /* ì¢Œ/ìš° ê· ë“± */
  .preview-box {
      flex: 1;                 /* âœ… ê· ë“± ë¶„ë°° */
      background: #fff;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      text-align: center;
      min-width: 0;
  }

  .preview-title {
      font-weight: bold;
      margin-bottom: 8px;
  }

  /* âœ… ì´ë¯¸ì§€ í‘œì‹œ ì˜ì—­ ê³ ì • (ì¢Œ/ìš° ë™ì¼ ë†’ì´) */
  .img-frame {
      width: 100%;
      height: 280px;           /* âœ… ê³ ì • ë†’ì´ */
      border: 1px solid #eee;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background: #fafafa;
  }

  .img-frame img {
      width: 100%;
      height: 100%;
      object-fit: contain;     /* âœ… ë¹„ìœ¨ ìœ ì§€ */
  }

  #errorBox { margin-top: 12px; }
  #errorMessage { font-size: 14px; line-height: 1.4; }

  .loading-spinner {
      width: 60px;
      height: 60px;
      border: 6px solid #e0e0e0;
      border-top: 6px solid #4a90e2;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 40px auto;
  }

  @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
  }

  .hidden { display: none; }
</style>

    
</head>

<body>
<div layout:fragment="content" class="container mt-4">

    <!-- í˜ì´ì§€ ì œëª© -->
    <h3 class="card-header mb-3">ğŸ¾ ë°˜ë ¤ë™ë¬¼ ìºë¦­í„° ìƒì„±</h3>

    <!-- ìºë¦­í„° ìƒì„± í¼ -->
    <form id="petForm" method="post" enctype="multipart/form-data">
        <div class="mb-3">
            <label for="file" class="form-label">ì›ë³¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ:</label>
            <input type="file" class="form-control" id="file" name="file"
                   accept="image/*" onchange="previewUploadImage(this)">
        </div>

        <div class="mb-3">
            <label for="kindpet" class="form-label">ë°˜ë ¤ë™ë¬¼ ì¢…:</label>
            <input type="text" class="form-control" id="kindpet" name="kindpet"
                   placeholder="ì˜ˆ: ê°•ì•„ì§€, ê³ ì–‘ì´ ë“±">
        </div>

        <div class="mb-3">
            <label for="userid" class="form-label">ì‚¬ìš©ì ID:</label>
            <input type="number" class="form-control" id="userid" name="userid"
                   placeholder="ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        </div>

        <div class="text-end">
            <button type="button" class="btn btn-primary"
                    onclick="generatePetCharacter()">ìºë¦­í„° ìƒì„±</button>
        </div>
    </form>

<!-- ğŸ”½ í•˜ë‹¨ ì´ë¯¸ì§€ ì˜ì—­ -->
<!-- <div class="bottom-preview"> -->

    <!-- ì¢Œì¸¡: ì—…ë¡œë“œ ì´ë¯¸ì§€ -->
    <div class="preview-box">
        <div class="preview-title">ğŸ“· ì—…ë¡œë“œ ì´ë¯¸ì§€</div>
        <!-- <img id="uploadPreview" src="" alt="ì—…ë¡œë“œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°"> -->
        <div class="img-frame">
  			<img id="uploadPreview" src="" alt="ì—…ë¡œë“œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°">
		</div>
    </div>

   <!-- ìš°ì¸¡: AI ìƒì„± ì´ë¯¸ì§€ -->
<div class="preview-box">
  <div class="preview-title">ğŸ¨ AI ìºë¦­í„° ì´ë¯¸ì§€</div>

  <div class="img-frame">
    <!-- ë¡œë”© -->
    <div id="loading" class="loading-spinner hidden"></div>

    <!-- ê²°ê³¼ ì´ë¯¸ì§€ -->
    <img id="aiResultImage" src="" alt="AI ìƒì„± ì´ë¯¸ì§€" class="hidden">
  </div>

  <!-- ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ (ì„±ê³µ ì‹œ í‘œì‹œ) -->
  <div class="mt-2">
    <button id="downloadBtn" type="button" class="btn btn-success btn-sm hidden"
            onclick="downloadAiImage()">â¬‡ï¸ ë‹¤ìš´ë¡œë“œ</button>
  </div>

  <!-- ì‹¤íŒ¨ ë©”ì‹œì§€ -->
  <div id="errorBox" class="hidden">
    <p id="errorMessage" class="text-danger mb-2"></p>
    <button type="button" class="btn btn-outline-danger btn-sm"
            onclick="retryGenerate()">ğŸ” ì¬ì‹œë„</button>
  </div>
</div>




<!-- </div> -->

<!-- JS ë¡œì§ -->
<script>
let lastFormData = null;
let lastAiImageUrl = null;

/* ì—…ë¡œë“œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° */
function previewUploadImage(input) {
  if (input.files && input.files[0]) {
    const url = URL.createObjectURL(input.files[0]);
    document.getElementById("uploadPreview").src = url;
  }
}

async function generatePetCharacter(formDataOverride) {
  const loading = document.getElementById("loading");
  const aiImage = document.getElementById("aiResultImage");
  const errorBox = document.getElementById("errorBox");
  const errorMessage = document.getElementById("errorMessage");
  const downloadBtn = document.getElementById("downloadBtn");

  /* UI ì´ˆê¸°í™” */
  loading.classList.remove("hidden");
  aiImage.classList.add("hidden");
  errorBox.classList.add("hidden");
  downloadBtn.classList.add("hidden");

  aiImage.src = "";
  errorMessage.innerText = "";
  lastAiImageUrl = null;

  const token = document.querySelector('meta[name="_csrf"]').content;
  const header = document.querySelector('meta[name="_csrf_header"]').content;

  const formData = formDataOverride || createFormData();
  lastFormData = formData;

  try {
    const res = await fetch("/api/pet/character", {
      method: "POST",
      headers: { [header]: token },
      body: formData
    });

    if (!res.ok) {
      let errorText = "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      try {
        const err = await res.json();
        errorText = err.message || err.error || errorText;
      } catch (e) {}
      throw new Error(errorText);
    }

    const data = await res.json();

    // âœ… ì„±ê³µ: ì´ë¯¸ì§€ í‘œì‹œ + ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ë…¸ì¶œ
    aiImage.src = data.url;
    aiImage.classList.remove("hidden");
    downloadBtn.classList.remove("hidden");
    lastAiImageUrl = data.url;

  } catch (e) {
    // âœ… ì‹¤íŒ¨: ì‚¬ìœ  í‘œì‹œ + ì¬ì‹œë„ ë²„íŠ¼ ë…¸ì¶œ
    errorMessage.innerText = e.message;
    errorBox.classList.remove("hidden");

  } finally {
    loading.classList.add("hidden");
  }
}

/* FormData ìƒì„± */
function createFormData() {
  const fileInput = document.getElementById("file");
  const kindpet = document.getElementById("kindpet").value.trim();
  const userid = document.getElementById("userid").value.trim();

  if (!userid) throw new Error("ì‚¬ìš©ì IDê°€ ì—†ìŠµë‹ˆë‹¤.");

  const formData = new FormData();
  if (fileInput.files.length > 0) formData.append("file", fileInput.files[0]);
  if (kindpet) formData.append("kindpet", kindpet);
  formData.append("userid", userid);

  return formData;
}

/* ì¬ì‹œë„ */
function retryGenerate() {
  if (lastFormData) generatePetCharacter(lastFormData);
}

/* âœ… AI ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ */
async function downloadAiImage() {
  if (!lastAiImageUrl) {
    alert("ë‹¤ìš´ë¡œë“œí•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  try {
    /**
     * 1) ê°™ì€ ë„ë©”ì¸/ì¸ì¦ì´ í•„ìš”í•œ ì´ë¯¸ì§€ì¼ ìˆ˜ ìˆì–´ fetchë¡œ blob ì²˜ë¦¬
     * 2) ì™¸ë¶€ CDNì¸ë° CORS ë§‰í˜€ìˆìœ¼ë©´ ì„œë²„ì—ì„œ í”„ë¡ì‹œ ë‹¤ìš´ë¡œë“œë¡œ ë°”ê¾¸ëŠ” ê²Œ ì •ì„
     */
    const res = await fetch(lastAiImageUrl, { method: "GET" });
    if (!res.ok) throw new Error("ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");

    const blob = await res.blob();
    const blobUrl = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = blobUrl;

    // íŒŒì¼ëª…: í•„ìš”í•˜ë©´ userid / timestamp ì„ì–´ì„œ ë§Œë“¤ ìˆ˜ ìˆìŒ
    a.download = "pet_character.png";
    document.body.appendChild(a);
    a.click();
    a.remove();

    URL.revokeObjectURL(blobUrl);
  } catch (e) {
    alert(e.message || "ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}
</script>





</div> 


</body>
</html>
