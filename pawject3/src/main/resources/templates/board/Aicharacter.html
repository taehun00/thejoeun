<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head lang="ko">
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <title>ë°˜ë ¤ë™ë¬¼ ìºë¦­í„° ìƒì„±</title>

    <style>
        /* í•˜ë‹¨ ê²°ê³¼ ì˜ì—­ */
        .bottom-preview {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            gap: 20px;
            z-index: 1000;
        }

        .preview-box {
            width: 48%;
            background: #fff;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            text-align: center;
        }

        .preview-box img {
            max-width: 100%;
            max-height: 280px;
            object-fit: contain;
        }

        .preview-title {
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        #errorBox {
    margin-top: 20px;
}
    </style>
    
    
	    <style>
	    .loading-spinner {
	        width: 60px;
	        height: 60px;
	        border: 6px solid #e0e0e0;
	        border-top: 6px solid #4a90e2;
	        border-radius: 50%;
	        animation: spin 1s linear infinite;
	        margin: 40px auto;
	    }
	
	    @keyframes spin {
	        0% { transform: rotate(0deg); }
	        100% { transform: rotate(360deg); }
	    }
	
	    .hidden {
	        display: none;
	    }
	</style>
    
</head>

<body>
<div layout:fragment="content" class="container mt-4">

    <!-- í˜ì´ì§€ ì œëª© -->
    <h3 class="card-header mb-3">ğŸ¾ ë°˜ë ¤ë™ë¬¼ ìºë¦­í„° ìƒì„±</h3>

    <!-- ìºë¦­í„° ìƒì„± í¼ -->
    <form id="petForm" method="post" enctype="multipart/form-data">
        <div class="mb-3">
            <label for="file" class="form-label">ì›ë³¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ</label>
            <input type="file" class="form-control" id="file" name="file"
                   accept="image/*" onchange="previewUploadImage(this)">
        </div>

        <div class="mb-3">
            <label for="kindpet" class="form-label">ë°˜ë ¤ë™ë¬¼ ì¢…</label>
            <input type="text" class="form-control" id="kindpet" name="kindpet"
                   placeholder="ì˜ˆ: ê°•ì•„ì§€, ê³ ì–‘ì´ ë“±">
        </div>

        <div class="mb-3">
            <label for="userid" class="form-label">ì‚¬ìš©ì ID</label>
            <input type="number" class="form-control" id="userid" name="userid"
                   placeholder="ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        </div>

        <div class="text-end">
            <button type="button" class="btn btn-primary"
                    onclick="generatePetCharacter()">ìºë¦­í„° ìƒì„±</button>
        </div>
    </form>

<!-- ğŸ”½ í•˜ë‹¨ ì´ë¯¸ì§€ ì˜ì—­ -->
<!-- <div class="bottom-preview"> -->

    <!-- ì¢Œì¸¡: ì—…ë¡œë“œ ì´ë¯¸ì§€ -->
    <div class="preview-box">
        <div class="preview-title">ğŸ“· ì—…ë¡œë“œ ì´ë¯¸ì§€</div>
        <img id="uploadPreview" src="" alt="ì—…ë¡œë“œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°">
    </div>

    <!-- ìš°ì¸¡: AI ìƒì„± ì´ë¯¸ì§€ -->
<div class="preview-box">
    <div class="preview-title">ğŸ¨ AI ìºë¦­í„° ì´ë¯¸ì§€</div>

    <!-- ë¡œë”© -->
    <div id="loading" class="loading-spinner hidden"></div>

    <!-- ì‹¤íŒ¨ ë©”ì‹œì§€ -->
    <div id="errorBox" class="hidden">
    <p id="errorMessage" class="text-danger mb-2"></p>
    <button type="button" class="btn btn-outline-danger btn-sm"
            onclick="retryGenerate()">ğŸ” ì¬ì‹œë„</button>
</div>


    <!-- ê²°ê³¼ ì´ë¯¸ì§€ -->
    <img id="aiResultImage" src="" alt="AI ìƒì„± ì´ë¯¸ì§€" class="hidden">
</div>



<!-- </div> -->

<!-- JS ë¡œì§ -->
<script>
let lastFormData = null;

async function generatePetCharacter(formDataOverride) {
    const loading = document.getElementById("loading");
    const aiImage = document.getElementById("aiResultImage");
    const errorBox = document.getElementById("errorBox");
    const errorMessage = document.getElementById("errorMessage");

    /* UI ì´ˆê¸°í™” */
    loading.classList.remove("hidden");
    aiImage.classList.add("hidden");
    errorBox.classList.add("hidden");
    aiImage.src = "";
    errorMessage.innerText = "";

    const token = document.querySelector('meta[name="_csrf"]').content;
    const header = document.querySelector('meta[name="_csrf_header"]').content;

    const formData = formDataOverride || createFormData();
    lastFormData = formData;

    try {
        const res = await fetch("/api/pet/character", {
            method: "POST",
            headers: {
                [header]: token
            },
            body: formData
        });

        if (!res.ok) {
            let errorText = "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";

            try {
                const err = await res.json();
                errorText = err.message || err.error || errorText;
            } catch (e) {
                /* JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ë©”ì‹œì§€ */
            }

            throw new Error(errorText);
        }

        const data = await res.json();

        aiImage.src = data.url;
        aiImage.classList.remove("hidden");

    } catch (e) {
        /* ì‹¤íŒ¨ UI */
        errorMessage.innerText = e.message;
        errorBox.classList.remove("hidden");

    } finally {
        loading.classList.add("hidden");
    }
}

/* FormData ìƒì„± */
function createFormData() {
    const fileInput = document.getElementById("file");
    const kindpet = document.getElementById("kindpet").value.trim();
    const userid = document.getElementById("userid").value.trim();

    if (!userid) {
        throw new Error("ì‚¬ìš©ì IDê°€ ì—†ìŠµë‹ˆë‹¤.");
    }

    const formData = new FormData();
    if (fileInput.files.length > 0) {
        formData.append("file", fileInput.files[0]);
    }
    if (kindpet) {
        formData.append("kindpet", kindpet);
    }
    formData.append("userid", userid);

    return formData;
}

/* ì¬ì‹œë„ */
function retryGenerate() {
    if (lastFormData) {
        generatePetCharacter(lastFormData);
    }
}

/* ì—…ë¡œë“œ ë¯¸ë¦¬ë³´ê¸°*/
function previewUploadImage(input) {
    if (input.files && input.files[0]) {
        const url = URL.createObjectURL(input.files[0]);
        document.getElementById("uploadPreview").src = url;
    }
}
</script>




</div> 


</body>
</html>
