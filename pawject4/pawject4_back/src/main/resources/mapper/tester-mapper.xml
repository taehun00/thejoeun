<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
	<mapper namespace="com.pawject.dao.tester.TesterDao">
	<resultMap   type="com.pawject.dto.tester.TesterAdminResponseDto" id="testerMap">

	<result property="testerid"	column="TESTERID"/>
	<result property="category"	column="CATEGORY"/>
	<result property="title"	    column="TITLE"/>
	<result property="content"	column="CONTENT"/>
	<result property="userid"	column="USERID"/>
	<result property="foodid"	column="FOODID"/>
	<result property="status"	column="STATUS"/>
	<result property="views"		column="VIEWS"/>
	<result property="isnotice"	column="ISNOTICE"/>
	<result property="posttype"	column="POSTTYPE"/>
	<result property="deleted"	column="DELETED"/>
	<result property="createdat"	column="CREATEDAT"/>
	<result property="updatedat"	column="UPDATEDAT"/>
	
	<result property="nickname" column="NICKNAME"/>
	<result property="foodname" column="FOODNAME"/>

	</resultMap>

<!-- 단건조회-jpa -->
<!-- 글쓰기-jpa-->
<!-- 수정-jpa-->
<!-- 삭제-jpa-->

<!--조회 영역-->
<!--페이징+정렬(1)-->
<select resultMap="testerMap" id="select20Tester" parameterType="java.util.HashMap">
	SELECT * 
	FROM(
	    SELECT ROW_NUMBER()OVER(
        <choose>
            <when test="condition == 'old'">
                ORDER BY T.ISNOTICE DESC, T.TESTERID ASC
            </when>
            <when test="condition == 'new'">
                ORDER BY T.ISNOTICE DESC, T.TESTERID DESC
            </when>

            <!-- 모집중 우선 정렬 -->
            <when test="condition == 'open' or condition == 'openOnly'">
                ORDER BY T.ISNOTICE DESC, T.STATUS ASC, T.TESTERID DESC
            </when>

            <!-- 모집완료 우선 정렬 -->
            <when test="condition == 'close' or condition == 'closeOnly'">
                ORDER BY T.ISNOTICE DESC, T.STATUS DESC, T.TESTERID DESC
            </when>

            <otherwise>
                ORDER BY T.ISNOTICE DESC, T.TESTERID DESC
            </otherwise>
        </choose>
	    )
	    AS RNUM,
	    T.TESTERID, T.CATEGORY, T.TITLE, T.CONTENT, U.NICKNAME,
	    T.ISNOTICE, T.STATUS, T.VIEWS, T.POSTTYPE, F.FOODNAME,
	    T.CREATEDAT, T.UPDATEDAT, T.DELETED
	    FROM TESTER T 
	    LEFT JOIN USERS U ON T.USERID = U.USERID
	    LEFT JOIN FOOD F ON T.FOODID=F.FOODID
	    WHERE T.DELETED = 0
	        <!-- 모집공고 필터 -->
	    <if test="condition == 'openOnly'">
	        AND T.POSTTYPE = 1 AND T.STATUS = 0
	    </if>
	    <if test="condition == 'closeOnly'">
	        AND T.POSTTYPE = 1 AND T.STATUS = 1
	    </if>
	    
	    )
	    WHERE RNUM BETWEEN #{start} AND #{end}
</select>

<!--페이징+정렬-카운트(2)-->
<select id="countByTesterPaging" resultType="int" parameterType="java.util.HashMap">
    SELECT COUNT(*)
    FROM TESTER T
    WHERE T.DELETED = 0
    <if test="condition == 'openOnly'">
        AND T.POSTTYPE = 1 AND T.STATUS = 0
    </if>
    <if test="condition == 'closeOnly'">
        AND T.POSTTYPE = 1 AND T.STATUS = 1
    </if>
</select>

<select resultMap="testerMap" id="searchTester" parameterType="java.util.HashMap">
SELECT *
FROM (
    SELECT ROW_NUMBER() OVER (
        <choose>
            <when test="condition == 'old'">
                ORDER BY T.ISNOTICE DESC, T.TESTERID ASC
            </when>
            <when test="condition == 'new'">
                ORDER BY T.ISNOTICE DESC, T.TESTERID DESC
            </when>

            <!-- 모집중 우선 정렬 -->
            <when test="condition == 'open' or condition == 'openOnly'">
                ORDER BY T.ISNOTICE DESC, T.STATUS ASC, T.TESTERID DESC
            </when>

            <!-- 모집완료 우선 정렬 -->
            <when test="condition == 'close' or condition == 'closeOnly'">
                ORDER BY T.ISNOTICE DESC, T.STATUS DESC, T.TESTERID DESC
            </when>

            <otherwise>
                ORDER BY T.ISNOTICE DESC, T.TESTERID DESC
            </otherwise>
        </choose>
    ) AS RNUM,
    T.TESTERID, T.CATEGORY, T.TITLE, T.CONTENT, U.NICKNAME,
    T.ISNOTICE, T.STATUS, T.VIEWS, T.POSTTYPE, T.FOODID,
    T.CREATEDAT, T.UPDATEDAT, T.DELETED
    FROM TESTER T
    LEFT JOIN USERS U ON T.USERID = U.USERID
    WHERE T.DELETED = 0

    <!-- 모집공고 필터 -->
    <if test="condition == 'openOnly'">
        AND T.POSTTYPE = 1 AND T.STATUS = 0
    </if>
    <if test="condition == 'closeOnly'">
        AND T.POSTTYPE = 1 AND T.STATUS = 1
    </if>

    <!-- 기존 검색 -->
    <choose>
        <when test="searchType == 'title'">
            AND lower(T.TITLE) like #{search}
        </when>
        <when test="searchType == 'content'">
            AND lower(T.CONTENT) like #{search}
        </when>
        <when test="searchType == 'nickname'">
            AND lower(U.NICKNAME) like #{search}
        </when>
        <when test="searchType == 'all'">
            AND (lower(T.TITLE) like #{search} OR lower(T.CONTENT) like #{search})
        </when>
    </choose>
)
WHERE RNUM BETWEEN #{start} AND #{end}
</select>



<!--페이징+정렬+검색-카운트(4)-->
<select resultType="int" id="searchTesterCnt" parameterType="java.util.HashMap">
SELECT COUNT(*)
    FROM TESTER T 
    LEFT JOIN USERS U ON T.USERID = U.USERID
    WHERE T.DELETED = 0
        <!-- 모집공고 필터 -->
    <if test="condition == 'openOnly'">
        AND T.POSTTYPE = 1 AND T.STATUS = 0
    </if>
    <if test="condition == 'closeOnly'">
        AND T.POSTTYPE = 1 AND T.STATUS = 1
    </if>
    <choose>
        <when test="searchType == 'title'">
            AND lower(T.TITLE) like #{search}
        </when>
        <when test="searchType == 'content'">
            AND lower(T.CONTENT) like #{search}
        </when>
        <when test="searchType == 'nickname'">
            AND lower(U.NICKNAME) like #{search}
        </when>
        <when test="searchType == 'all'">
            AND (lower(T.TITLE) like #{search} OR lower(T.CONTENT) like #{search})
        </when>
    </choose>
</select>

<!--기능 영역-->
<!--공지 올리고 내리기 0공지x 1공지중 -->
<update id="updateIsnotice" parameterType="Long">
    UPDATE TESTER SET ISNOTICE = CASE WHEN ISNOTICE = 0 THEN 1 ELSE 0 END
    WHERE TESTERID = #{testerid}
</update>
<!--공지 여부 반환-->
<select id="selectIsnotice" resultType="Long">
  SELECT ISNOTICE FROM TESTER WHERE TESTERID = #{testerid}
</select>
<!--모집 여부 0모집중 1모집완료 -->
<update id="updateStatus" parameterType="Long">
    UPDATE TESTER SET STATUS = CASE WHEN STATUS = 0 THEN 1 ELSE 0 END
    WHERE TESTERID = #{testerid}
</update>

<!--모집 여부 반환-->
<select id="selectStatus" resultType="Long">
  SELECT STATUS FROM TESTER WHERE TESTERID = #{testerid}
</select>

<!--조회수 증가-->
<update id="updateViews" parameterType="Long">
  UPDATE TESTER  SET VIEWS = NVL(VIEWS, 0) + 1
  WHERE TESTERID = #{testerid}
</update>

</mapper>