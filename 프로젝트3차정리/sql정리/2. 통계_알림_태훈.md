-- 모두 확인 완료

-- 펫 정보 작성
INSERT INTO PETS (
            PETID, USERID, PETNAME, PETBREED, BIRTHDATE, PETTYPEID,
            PFILE, CREATEDAT, AGE, GENDER, WEIGHT, HEIGHT, BODYSCORE, ACTIVITYLEVEL
        ) VALUES (
            #{petId}, #{userId}, #{petName}, #{petBreed}, #{birthDate}, #{petTypeId},
            #{pfile}, SYSDATE, #{age}, #{gender}, #{weight}, #{height}, #{bodyScore}, #{activityLevel}
        )

INSERT INTO PETDISEASE (
            PETDISEASEID, PETID, DISEASEID
        ) VALUES (
            #{petDiseaseId}, #{petId}, #{diseaseId}
        )
INSERT INTO PETFOOD (
            PETFOODID, PETID, FOODID
        ) VALUES (
            #{petFoodId}, #{petId}, #{foodId}
        )

-- 펫 모든 정보 조회(질병, 음식까지)
SELECT 
    p.PETID,
    p.USERID,
    p.PETNAME,
    p.PETBREED,
    p.BIRTHDATE,
    p.PETTYPEID,
    p.PFILE,
    p.CREATEDAT,
    p.AGE,
    p.GENDER,
    p.WEIGHT,
    p.HEIGHT,
    p.BODYSCORE,
    p.ACTIVITYLEVEL,
    d.DISNAME      AS DISEASE_NAME,
    f.mainingredient     AS FOOD_NAME
FROM PETS p
LEFT JOIN PETDISEASE pd ON p.PETID = pd.PETID
LEFT JOIN DISEASE d ON pd.DISEASEID = d.DISNO
LEFT JOIN PETFOOD pf ON p.PETID = pf.PETID
LEFT JOIN FOOD f ON pf.FOODID = f.FOODID;

-- 어떤 브랜드의 음식이 많이 리뷰되었는지 ( 집에서 확인 )
SELECT 
    fb.BRANDNAME,
    f.FOODNAME,
    COUNT(*) AS REVIEW_COUNT
FROM REVIEW r
JOIN FOOD f ON r.FOODID = f.FOODID
JOIN FOODBRAND fb ON f.BRANDID = fb.BRANDID
GROUP BY fb.BRANDNAME, f.FOODNAME
ORDER BY fb.BRANDNAME, REVIEW_COUNT DESC;


-- 어떤 브랜드(만)가 많이 리뷰되었는지 ( 집에서 확인 )
SELECT 
    fb.BRANDNAME,
    COUNT(*) AS REVIEW_COUNT
FROM REVIEW r
JOIN FOOD f ON r.FOODID = f.FOODID
JOIN FOODBRAND fb ON f.BRANDID = fb.BRANDID
GROUP BY fb.BRANDNAME
ORDER BY REVIEW_COUNT DESC;



-- 기본 셋팅
INSERT INTO USERS (userid, email, nickname, password, ufile, createdat, mobile, provider, providerid) VALUES
(1, 'user1@example.com', '닉네임1', 'pass1', 'user1.png', SYSDATE, '010-1111-1111', 'local', 'localid');
INSERT INTO USERS VALUES (2, 'user2@example.com', '닉네임2', 'pass2', 'user2.png', SYSDATE, '010-1111-1112', 'local', 'localid');
INSERT INTO USERS VALUES (3, 'user3@example.com', '닉네임3', 'pass3', 'user3.png', SYSDATE, '010-1111-1113', 'local', 'localid');

-- 0. 알림 설정 등록
-- (1번 사용자) 회원가입 시 기본 셋팅
INSERT INTO NOTIFICATION_SETTING (USERID, BOARDTYPE, ENABLED)
VALUES (1, 'REVIEW', 'Y');

-- 알림설정 ( Y or N )
UPDATE NOTIFICATION_SETTING
SET ENABLED = 'N'
WHERE USERID = 1
  AND BOARDTYPE = 'REVIEW';
  
UPDATE NOTIFICATION_SETTING
SET ENABLED = 'Y'
WHERE USERID = 1
  AND BOARDTYPE = 'REVIEW';


-- 1. 리뷰 작성
-- (1번 사용자)이 리뷰 작성
INSERT INTO REVIEW (REVIEWID, USERID, BRANDID, FOODID, REVIEWIMG, RATING, TITLE, REVIEWCOMMENT, CREATEDAT)
VALUES (101, 1, 10, 100, 'img1.jpg', 5, '사료 후기', '강아지가 잘 먹어요!', SYSDATE);

-- 2. 좋아요 발생
-- (2번 사용자)가 (1번사용자)의 리뷰 하트
INSERT INTO POST_LIKE (LIKEID, BOARDTYPE, POSTID, USERID, CREATEDAT)
VALUES (SEQ_POST_LIKE.NEXTVAL, 'REVIEW', 101, 2, SYSDATE);

-- (3번 사용자)가 (1번사용자)의 리뷰 하트
INSERT INTO POST_LIKE (LIKEID, BOARDTYPE, POSTID, USERID, CREATEDAT)
VALUES (SEQ_POST_LIKE.NEXTVAL, 'REVIEW', 101, 3, SYSDATE);

-- 3. 알람 설정 확인
SELECT ENABLED
FROM NOTIFICATION_SETTING
WHERE USERID = 1
  AND BOARDTYPE = 'REVIEW';


-- 알림설정이 Y인 경우 알림 보냄
SELECT R.REVIEWID,
       R.TITLE,
       L.USERID AS ACTIONUSER,
       U.NICKNAME AS ACTIONUSERNAME,
       R.USERID AS AUTHORID
FROM POST_LIKE L
JOIN REVIEW R ON L.POSTID = R.REVIEWID AND L.BOARDTYPE = 'REVIEW'
JOIN USERS U ON L.USERID = U.USERID
JOIN NOTIFICATION_SETTING N ON R.USERID = N.USERID AND N.BOARDTYPE = 'REVIEW'
WHERE R.REVIEWID = 101
  AND N.ENABLED = 'Y';

-- 특정 글의 하트 개수 조회
SELECT COUNT(*) AS HEARTS
FROM POST_LIKE
WHERE BOARDTYPE = 'REVIEW'
  AND POSTID = 101;

-- 사용자 1 이 작성한 리뷰들
SELECT R.REVIEWID,
       R.TITLE,
       COUNT(L.LIKEID) AS HEARTS
FROM REVIEW R
LEFT JOIN POST_LIKE L
       ON R.REVIEWID = L.POSTID
      AND L.BOARDTYPE = 'REVIEW'
WHERE R.USERID = 1
GROUP BY R.REVIEWID, R.TITLE;


-- 알림 설정
UPDATE NOTIFICATION_SETTING
SET ENABLED = 'N'
WHERE USERID = 1 AND TYPE = '운동정보';
